import{r as i}from"./index-BTX2eULV.js";import{i as f,n as d}from"./const-BP60AzNb.js";import{u as l}from"./index-BAmm0iof.js";function O(e,...t){var n;(n=e==null?void 0:e.addEventListener)==null||n.call(e,...t)}function z(e,...t){var n;(n=e==null?void 0:e.removeEventListener)==null||n.call(e,...t)}const K=(e,t)=>Object.hasOwn(e,t);function v(){const e=i.useRef(!0);return i.useEffect(()=>{e.current=!1},[]),e.current}const M=f?i.useLayoutEffect:i.useEffect;function I(e,t){const n=v();i.useEffect(n?d:e,t)}function T(e){return typeof e=="function"&&(e=e()),e}function _(e,t){return typeof e=="function"?e(t):e}function B(...e){return e.length===1?T(e[0]):_(e[0],e[1])}const a=new Map,p=(e,t,n,r)=>{var h;const s=(h=a.get(e))==null?void 0:h.get(t);if(!(s===void 0||s.size===0))for(const o of s)o!==r&&o(n)},A=e=>{e.storageArea&&e.key&&e.newValue&&p(e.storageArea,e.key,e.newValue)},N=(e,t,n)=>{f&&a.size===0&&O(globalThis,"storage",A,{passive:!0});let r=a.get(e);r||(r=new Map,a.set(e,r));let s=r.get(t);s||(s=new Set,r.set(t,s)),s.add(n)},P=(e,t,n)=>{const r=a.get(e);if(!r)return;const s=r.get(t);s&&(s.delete(n),s.size===0&&r.delete(t),r.size===0&&a.delete(e),f&&a.size===0&&z(globalThis,"storage",A))},W={defaultValue:null,initializeWithValue:!0};function H(e,t,n){var V;const r=l({...W,...n}),s=(u,c)=>(r.current.parse??U)(u,c),h=u=>(r.current.stringify??J)(u),o=l({fetchRaw:()=>e.getItem(t),fetch:()=>s(o.current.fetchRaw(),r.current.defaultValue),remove(){e.removeItem(t)},store(u){const c=h(u);return c!==null&&e.setItem(t,c),c}}),y=v(),[g,L]=i.useState((V=r.current)!=null&&V.initializeWithValue&&y?o.current.fetch():void 0),R=l(g),m=l({fetch(){L(o.current.fetch())},setRawVal(u){L(s(u,r.current.defaultValue))}});I(()=>{m.current.fetch()},[t]),i.useEffect(()=>{r.current.initializeWithValue||m.current.fetch()},[]),M(()=>{const u=m.current.setRawVal;return N(e,t,u),()=>{P(e,t,u)}},[e,t]);const S=l({set(u){if(!f)return;const c=B(u,R.current),w=o.current.store(c);w!==null&&p(e,t,w)},delete(){f&&(o.current.remove(),p(e,t,null))},fetch(){f&&p(e,t,o.current.fetchRaw())}}),F=i.useMemo(()=>({set:u=>{S.current.set(u)},remove(){S.current.delete()},fetch(){S.current.fetch()}}),[]);return i.useMemo(()=>({value:g,...F}),[g])}const J=e=>{if(e===null)return null;try{return JSON.stringify(e)}catch(t){return console.warn(t),null}},U=(e,t)=>{if(e===null)return t;try{return JSON.parse(e)}catch(n){return console.warn(n),t}};let E;try{E=f&&!!globalThis.localStorage}catch{E=!1}const q=E?(e,t)=>H(localStorage,e,t):(e,t)=>({value:void 0,set:d,remove:d,fetch:d});export{z as a,K as h,O as o,q as u};
