import{r as o}from"./index-d3rqgMCN.js";import{i as f,n as d}from"./const-BP60AzNb.js";import{u as l}from"./index-Cwz0kwco.js";function z(e,...t){var n;(n=e==null?void 0:e.addEventListener)==null||n.call(e,...t)}function M(e,...t){var n;(n=e==null?void 0:e.removeEventListener)==null||n.call(e,...t)}function w(){const e=o.useRef(!0);return o.useEffect(()=>{e.current=!1},[]),e.current}const I=f?o.useLayoutEffect:o.useEffect;function O(e,t){const n=w();o.useEffect(n?d:e,t)}function T(e){return typeof e=="function"&&(e=e()),e}function _(e,t){return typeof e=="function"?e(t):e}function B(...e){return e.length===1?T(e[0]):_(e[0],e[1])}const a=new Map,g=(e,t,n,r)=>{var h;const s=(h=a.get(e))==null?void 0:h.get(t);if(!(s===void 0||s.size===0))for(const i of s)i!==r&&i(n)},A=e=>{e.storageArea&&e.key&&e.newValue&&g(e.storageArea,e.key,e.newValue)},N=(e,t,n)=>{f&&a.size===0&&z(globalThis,"storage",A,{passive:!0});let r=a.get(e);r||(r=new Map,a.set(e,r));let s=r.get(t);s||(s=new Set,r.set(t,s)),s.add(n)},W=(e,t,n)=>{const r=a.get(e);if(!r)return;const s=r.get(t);s&&(s.delete(n),s.size===0&&r.delete(t),r.size===0&&a.delete(e),f&&a.size===0&&M(globalThis,"storage",A))},H={defaultValue:null,initializeWithValue:!0};function J(e,t,n){var v;const r=l({...H,...n}),s=(u,c)=>(r.current.parse??U)(u,c),h=u=>(r.current.stringify??P)(u),i=l({fetchRaw:()=>e.getItem(t),fetch:()=>s(i.current.fetchRaw(),r.current.defaultValue),remove(){e.removeItem(t)},store(u){const c=h(u);return c!==null&&e.setItem(t,c),c}}),R=w(),[p,V]=o.useState((v=r.current)!=null&&v.initializeWithValue&&R?i.current.fetch():void 0),y=l(p),m=l({fetch(){V(i.current.fetch())},setRawVal(u){V(s(u,r.current.defaultValue))}});O(()=>{m.current.fetch()},[t]),o.useEffect(()=>{r.current.initializeWithValue||m.current.fetch()},[]),I(()=>{const u=m.current.setRawVal;return N(e,t,u),()=>{W(e,t,u)}},[e,t]);const S=l({set(u){if(!f)return;const c=B(u,y.current),E=i.current.store(c);E!==null&&g(e,t,E)},delete(){f&&(i.current.remove(),g(e,t,null))},fetch(){f&&g(e,t,i.current.fetchRaw())}}),F=o.useMemo(()=>({set:u=>{S.current.set(u)},remove(){S.current.delete()},fetch(){S.current.fetch()}}),[]);return o.useMemo(()=>({value:p,...F}),[p])}const P=e=>{if(e===null)return null;try{return JSON.stringify(e)}catch(t){return console.warn(t),null}},U=(e,t)=>{if(e===null)return t;try{return JSON.parse(e)}catch(n){return console.warn(n),t}};let L;try{L=f&&!!globalThis.localStorage}catch{L=!1}const K=L?(e,t)=>J(localStorage,e,t):(e,t)=>({value:void 0,set:d,remove:d,fetch:d});export{K as u};
