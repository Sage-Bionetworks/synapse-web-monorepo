import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{d as ie}from"./enums-Cg9953X4.js";import"./iframe-Dgw0ddSq.js";import{r as b}from"./index-yCXaIsJ4.js";import{T as oe,n as x,F as q}from"./VerificationSubmission-CNoSrCdk.js";import{m as z,ao as le,l as ce,v as F}from"./useFiles-BPERm-cu.js";import"./StringUtils-BmiE0y30.js";import"./OrientationBanner-DwasDZmJ.js";import{a as de}from"./useDataAccessSubmission-COxjEYlr.js";import{q as ue,r as me}from"./useAccessRequirements-C7JAG32b.js";import{I as H}from"./IconSvg-CnT4vWM-.js";import{U as pe}from"./UserBadge-FhFGZyGx.js";import{U as he}from"./UserSearchBoxV2-uIaFwRHI.js";import{T as i}from"./Typography-CmGZeFeL.js";import{S as K}from"./Stack-7VNSqroz.js";import{B as S}from"./Button-Bdu-kUqw.js";import{R as fe}from"./RadioGroup-cShbmYzJ.js";import{F as M}from"./FormControlLabel-BsZkQT3s.js";import{R as W}from"./Radio-CyPLaZpE.js";import{D as xe,U as k}from"./UploadDocumentField-CWqlVWop.js";import{B as w}from"./Box-CRuUmbYm.js";import{M as ye}from"./ManagedACTAccessRequirementFormWikiWrapper-JFOHXJfj.js";import{D as je}from"./DialogTitle-DqXELuAo.js";import{I as ge}from"./IconButton-CblLNGjE.js";import{D as be,a as Ie}from"./DialogContent-DdlbzZR9.js";import{D as T}from"./Divider-B_D3n_cy.js";import{A as Ce}from"./Alert-DTtaGRoB.js";import{c as ve}from"./createSvgIcon-DdAS40k4.js";import{L as we}from"./Link-B9YecAyg.js";const Ae=ve(e.jsx("path",{d:"m23 12-2.44-2.78.34-3.68-3.61-.82-1.89-3.18L12 3 8.6 1.54 6.71 4.72l-3.61.81.34 3.68L1 12l2.44 2.78-.34 3.69 3.61.82 1.89 3.18L12 21l3.4 1.46 1.89-3.18 3.61-.82-.34-3.68zm-4.51 2.11.26 2.79-2.74.62-1.43 2.41L12 18.82l-2.58 1.11-1.43-2.41-2.74-.62.26-2.8L3.66 12l1.85-2.12-.26-2.78 2.74-.61 1.43-2.41L12 5.18l2.58-1.11 1.43 2.41 2.74.62-.26 2.79L20.34 12zM11 15h2v2h-2zm0-8h2v6h-2z"}));function _(u){const{accessorChanges:c,onChange:s,isRenewal:d,helpText:I}=u,{data:l}=z(),C=(a,n)=>{n&&s(o=>{if(!o.map(m=>m.userId).includes(n.ownerId)){const m={userId:n.ownerId,type:x.GAIN_ACCESS};o.push(m)}return o})},y=a=>{s(n=>n.filter(o=>o.userId!==a))},j=(a,n)=>{s(o=>{const h=o.findIndex(m=>m.userId===n);return o[h].type=a,o})};return e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"headline3",sx:{mt:4,mb:2},children:"Data Requesters"}),e.jsx(i,{variant:"body1",sx:{mb:1},className:"requester-label",children:I}),e.jsx(he,{inputId:"requesters",typeFilter:oe.USERS_ONLY,onChange:C,filterPredicate:a=>!c.map(n=>n.userId).includes(a.ownerId),value:null}),e.jsx(K,{sx:{my:1,gap:1},children:c.map((a,n)=>e.jsxs("div",{className:"list-items",children:[e.jsx(pe,{userId:a.userId,showAccountLevelIcon:!0,disableLink:!0,showFullName:!0}),(l==null?void 0:l.ownerId)!==a.userId&&a.type===x.GAIN_ACCESS&&e.jsx(S,{"aria-label":"Remove user",variant:"text",sx:{ml:1,px:0},onClick:()=>y(a.userId),children:e.jsx(H,{icon:"clear"})}),d&&(l==null?void 0:l.ownerId)!==a.userId&&a.type!==x.GAIN_ACCESS&&e.jsx(e.Fragment,{children:e.jsxs(fe,{value:a.type,onChange:(o,h)=>j(h,a.userId),children:[e.jsx(M,{control:e.jsx(W,{}),label:"Renew",value:x.RENEW_ACCESS}),e.jsx(M,{control:e.jsx(W,{}),label:"Revoke",value:x.REVOKE_ACCESS})]})})]},`accessor-${n}`))})]})}try{_.displayName="DataAccessRequestAccessorsEditor",_.__docgenInfo={description:"Component that handles adding/removing/revoking accessors for a data access request.",displayName:"DataAccessRequestAccessorsEditor",props:{accessorChanges:{defaultValue:null,description:"",name:"accessorChanges",required:!0,type:{name:"AccessorChange[]"}},onChange:{defaultValue:null,description:"",name:"onChange",required:!0,type:{name:"(updater: (prevValue: AccessorChange[]) => AccessorChange[]) => void"}},isRenewal:{defaultValue:null,description:"",name:"isRenewal",required:!0,type:{name:"boolean"}},helpText:{defaultValue:null,description:"",name:"helpText",required:!0,type:{name:"ReactNode"}}}}}catch{}function E(u){var y,j;const{title:c,description:s,fileHandleAssociation:d,downloadButtonText:I}=u,{data:l}=le({requestedFiles:[d],includeFileHandles:!0,includePreSignedURLs:!1,includePreviewPreSignedURLs:!1},{enabled:!!d}),C=(j=(y=l==null?void 0:l.requestedFiles[0])==null?void 0:y.fileHandle)==null?void 0:j.fileName;return e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"headline3",sx:{mt:4,mb:2},children:c}),e.jsx(i,{variant:"body1",sx:{my:2},children:s}),e.jsx(i,{variant:"body1",children:"Download this file:"}),e.jsx(i,{variant:"smallText1",sx:{my:.5},children:e.jsx("strong",{children:C})}),e.jsxs(w,{sx:{display:"flex",alignItems:"center",justifyContent:"flex-start",gap:2,backgroundColor:"tertiary.100",p:2.5,my:2,flexWrap:{xs:"nowrap",md:"wrap-reverse"}},children:[e.jsx(xe,{variant:"outlined",fileHandleAssociation:d,fileName:I,endIcon:e.jsx(H,{icon:"download",wrap:!1}),sx:{whiteSpace:"nowrap",flexShrink:0}}),e.jsxs(i,{variant:"body1",children:["You must fill out and upload this exact version of the template."," ",e.jsx("strong",{children:"No other versions will be accepted."})]})]})]})}try{E.displayName="DocumentTemplate",E.__docgenInfo={description:"",displayName:"DocumentTemplate",props:{title:{defaultValue:null,description:"",name:"title",required:!0,type:{name:"ReactNode"}},description:{defaultValue:null,description:"",name:"description",required:!0,type:{name:"ReactNode"}},fileHandleAssociation:{defaultValue:null,description:"",name:"fileHandleAssociation",required:!0,type:{name:"FileHandleAssociation"}},downloadButtonText:{defaultValue:null,description:"",name:"downloadButtonText",required:!0,type:{name:"string"}}}}}catch{}function qe(u){const{managedACTAccessRequirement:c}=u;let s="",d="";return c.isCertifiedUserRequired&&c.isValidatedProfileRequired?(s="https://help.synapse.org/docs/User-Types.2007072795.html",d="All data requesters must be certified users and have a validated user profile."):c.isCertifiedUserRequired?(s="https://help.synapse.org/docs/User-Types.2007072795.html#UserAccountTiers-CertifiedUsers",d="All data requesters must be a certified user."):c.isValidatedProfileRequired&&(s="https://help.synapse.org/docs/User-Types.2007072795.html#UserAccountTiers-ValidatedUsers",d="All data requesters must have a validated user profile."),e.jsxs(e.Fragment,{children:[c.isDUCRequired?e.jsxs(w,{sx:{display:"flex",gap:2,alignItems:"center",py:1},children:[e.jsx(Ae,{sx:{color:"error.main"}}),e.jsx("div",{children:"You must list the Synapse user names of all collaborators listed in your Data Use Certificate (DUC)."})]}):"",d," ",s&&e.jsx(we,{href:s,target:"_blank",rel:"noreferrer",children:"Learn more"})]})}function Y(u){const{onSubmissionCreated:c,managedACTAccessRequirement:s,subjectId:d,subjectType:I,researchProjectId:l,onCancel:C,onBackClicked:y}=u,{accessToken:j}=ce(),a=!!j,{data:n}=z({enabled:a}),[o,h]=b.useState(),[m,N]=b.useState(),[B,$]=b.useState(),[L,J]=b.useState(),{data:t,isLoading:Q}=ue(String(s.id),{enabled:a,staleTime:1/0,throwOnError:!0}),v=(t==null?void 0:t.concreteType)==="org.sagebionetworks.repo.model.dataaccess.Renewal";function O(r){console.log("RequestDataAccessStep2: Error updating form",r),h({key:"error",message:V(r.reason)})}const{mutate:X,isPending:D}=de({onSuccess:r=>{c(r.submissionId)},onError:O}),{mutateAsync:g,isPending:Z}=me({onError:O}),R=Q||Z||D;b.useEffect(()=>{if(t&&n){let r=!1;t.researchProjectId||(t.researchProjectId=l,r=!0);const p={userId:n.ownerId,type:v?x.RENEW_ACCESS:x.GAIN_ACCESS};(!t.accessorChanges||!t.accessorChanges.find(A=>ie(A,p)))&&(t.accessorChanges=[p,...t.accessorChanges||[]],r=!0);const f=new Set,G=t.accessorChanges.filter(A=>f.has(A.userId)?!1:f.add(A.userId));G.length!==t.accessorChanges.length&&(t.accessorChanges=G,r=!0),r&&g(t)}},[t,v,l,g,n]),b.useEffect(()=>{t&&(t.accessorChanges&&m==null&&N(t.accessorChanges),v&&t.publication&&L==null&&J(t.publication),v&&t.summaryOfUse&&B==null&&$(t.summaryOfUse))},[t]);function P(){return{...t,accessorChanges:m,publication:L,summaryOfUse:B}}async function ee(){if(t){const r=await g(P());X({request:{requestId:r.id,requestEtag:r.etag,subjectId:d,subjectType:I},accessRequirementId:String(s.id)})}}const V=(r="")=>e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"Sorry, there is an error in submitting your request."}),e.jsx("br",{}),r]}),se=r=>{N([...r(m||[])])},te=r=>{var p;g({...t,attachments:(p=t.attachments)==null?void 0:p.filter(f=>f!==r)})},U=(r,p)=>{if(r.resp&&r.success){const f=r.resp;g(p==="attachments"?{...t,attachments:[...t.attachments||[],f.fileHandleId]}:{...t,[p]:f.fileHandleId})}else!r.success&&r.error&&(console.log("RequestDataAccessStep2: Error uploading the file",r.error),h({key:"error",message:V(r.error.reason)}))},re=t!=null&&t.ducFileHandleId?[{fileHandleId:t==null?void 0:t.ducFileHandleId,associateObjectType:q.DataAccessRequestAttachment,associateObjectId:String(t.id)}]:[],ae=t!=null&&t.irbFileHandleId?[{fileHandleId:t.irbFileHandleId,associateObjectType:q.DataAccessRequestAttachment,associateObjectId:String(t.id)}]:[],ne=((t==null?void 0:t.attachments)||[]).map(r=>({fileHandleId:r,associateObjectType:q.DataAccessRequestAttachment,associateObjectId:String(t.id)}))??[];return e.jsxs(e.Fragment,{children:[e.jsx(je,{children:e.jsxs(K,{direction:"row",sx:{alignItems:"center",gap:"5px"},children:["Request Access",e.jsx(w,{sx:{flexGrow:1}}),e.jsx(ge,{onClick:u.onHide,children:e.jsx(H,{icon:"close",wrap:!1,sx:{color:"grey.700"}})})]})}),e.jsxs(be,{children:[e.jsx(ye,{managedACTAccessRequirementId:String(s.id),children:e.jsxs(w,{component:"form",sx:{minHeight:"475px"},onSubmit:r=>r.preventDefault(),children:[e.jsx(i,{variant:"body1",sx:{mb:2},children:"Please provide the information below to submit the request for access."}),t&&n&&e.jsx(_,{accessorChanges:m||[],onChange:se,isRenewal:v,helpText:e.jsx(qe,{managedACTAccessRequirement:s})}),((s==null?void 0:s.isDUCRequired)||(s==null?void 0:s.isIRBApprovalRequired)||(s==null?void 0:s.areOtherAttachmentsRequired))&&e.jsx(T,{sx:{my:4}}),(s==null?void 0:s.isDUCRequired)&&e.jsxs(e.Fragment,{children:[(s==null?void 0:s.ducTemplateFileHandleId)&&e.jsx(E,{title:"Download DUC Template",description:"As a first step, you will need to download the most current version of the Data Use Certificate.",fileHandleAssociation:{fileHandleId:s.ducTemplateFileHandleId,associateObjectType:q.AccessRequirementAttachment,associateObjectId:String(s.id)},downloadButtonText:"Download DUC Template"}),e.jsx(i,{variant:"headline3",sx:{mt:4,mb:2},children:"Fill out and upload a Data Use Certificate"}),e.jsx(i,{variant:"body1",sx:{my:2},children:"You must download and fill out a Data Use Certificate (DUC). Be sure to upload the completed DUC below once you've completed it."}),e.jsxs(i,{variant:"body1",component:"ol",children:[e.jsx("li",{children:"Download the DUC template file."}),e.jsx("li",{children:"Fill out the DUC template, following the instructions in the file."}),e.jsx("li",{children:"Upload the completed certificate using the button below:"})]}),e.jsx(F,{children:e.jsx(k,{id:"duc",isLoading:R,uploadCallback:r=>U(r,"ducFileHandleId"),documentName:"Data Use Certificate",fileHandleAssociations:re})}),((s==null?void 0:s.isIRBApprovalRequired)||(s==null?void 0:s.areOtherAttachmentsRequired))&&e.jsx(T,{sx:{my:4}})]}),(s==null?void 0:s.isIRBApprovalRequired)&&e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"headline3",sx:{my:2},children:"IRB Approval"}),e.jsx(i,{variant:"body1",sx:{my:2},children:"Upload a signed IRB letter on institutional letterhead. The letter must include the names of all the datasets requested, as well as the names of the data requesters above. Use the button below to upload the document."}),e.jsx(F,{children:e.jsx(k,{id:"irb",isLoading:R,documentName:"IRB Approval Letter",uploadCallback:r=>U(r,"irbFileHandleId"),fileHandleAssociations:ae})}),(s==null?void 0:s.areOtherAttachmentsRequired)&&e.jsx(T,{sx:{my:4}})]}),(s==null?void 0:s.areOtherAttachmentsRequired)&&e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"headline3",sx:{my:2},children:"Upload other required documents"}),e.jsx(i,{variant:"body1",sx:{my:2},children:"You must upload other required documents. Please review the instructions to gain data access to determine which documents must also be uploaded."}),e.jsx(F,{children:e.jsx(k,{id:"file-attachment",isLoading:R,documentName:"Attachment",uploadCallback:r=>U(r,"attachments"),isMultiFileUpload:!0,fileHandleAssociations:ne,onClearAttachment:te})})]})]})}),o&&e.jsx(Ce,{severity:o.key,children:o.message})]}),e.jsxs(Ie,{children:[e.jsx(S,{variant:"outlined",onClick:()=>{y()},children:"Back"}),e.jsx(w,{sx:{flexGrow:1}}),e.jsx(S,{variant:"outlined",disabled:D,onClick:()=>{t&&C(P())},children:"Cancel"}),e.jsx(S,{variant:"contained",disabled:D,onClick:()=>{ee()},children:"Submit"})]})]})}try{Y.displayName="DataAccessRequestAccessorsFilesForm",Y.__docgenInfo={description:`Step 2 of the Data Access Request/Renewal flow prompts the user to
- Manage the list of accessors, i.e. Synapse users who will gain, renew, or lose access
- Download and upload documents required by the Access Requirement
- If a renewal, provide publications and a summary of use statement.

The component expects a researchProjectId, which should reference complete researchProject created in Step 1.
The user may click a "Submit" button, which will save the request and issue a data access submission that references
the requestId created/updated in this component.`,displayName:"DataAccessRequestAccessorsFilesForm",props:{subjectId:{defaultValue:null,description:"The ID of the object of interest. This corresponds to the subjectId of the {@link CreateSubmissionRequest }",name:"subjectId",required:!0,type:{name:"string"}},subjectType:{defaultValue:null,description:"",name:"subjectType",required:!0,type:{name:"enum",value:[{value:'"ENTITY"'},{value:'"EVALUATION"'},{value:'"TEAM"'}]}},managedACTAccessRequirement:{defaultValue:null,description:"",name:"managedACTAccessRequirement",required:!0,type:{name:"ManagedACTAccessRequirement"}},onSubmissionCreated:{defaultValue:null,description:"",name:"onSubmissionCreated",required:!0,type:{name:"(submissionId: string) => void"}},researchProjectId:{defaultValue:null,description:"",name:"researchProjectId",required:!0,type:{name:"string"}},onHide:{defaultValue:null,description:"",name:"onHide",required:!0,type:{name:"() => void"}},onCancel:{defaultValue:null,description:"",name:"onCancel",required:!0,type:{name:"(modifiedDataAccessRequest: Request | Renewal) => void"}},onBackClicked:{defaultValue:null,description:"Callback invoked when the 'Back' action button is clicked",name:"onBackClicked",required:!0,type:{name:"() => void"}}}}}catch{}export{Y as D};
