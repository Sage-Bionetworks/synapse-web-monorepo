import{R as O,r as Q}from"./index-76fb7be0.js";import{ab as g,a6 as y,ac as m,ad as R,a7 as M,l as E}from"./SynapseClient-d41c1eb3.js";import{_}from"./inheritsLoose-c82a83d4.js";var q=function(b){_(v,b);function v(u,r){var e;return e=b.call(this)||this,e.client=u,e.queries=[],e.result=[],e.observers=[],e.observersMap={},r&&e.setQueries(r),e}var i=v.prototype;return i.onSubscribe=function(){var r=this;this.listeners.length===1&&this.observers.forEach(function(e){e.subscribe(function(s){r.onUpdate(e,s)})})},i.onUnsubscribe=function(){this.listeners.length||this.destroy()},i.destroy=function(){this.listeners=[],this.observers.forEach(function(r){r.destroy()})},i.setQueries=function(r,e){this.queries=r,this.updateObservers(e)},i.getCurrentResult=function(){return this.result},i.getOptimisticResult=function(r){return this.findMatchingObservers(r).map(function(e){return e.observer.getOptimisticResult(e.defaultedQueryOptions)})},i.findMatchingObservers=function(r){var e=this,s=this.observers,a=r.map(function(n){return e.client.defaultQueryObserverOptions(n)}),o=a.flatMap(function(n){var c=s.find(function(l){return l.options.queryHash===n.queryHash});return c!=null?[{defaultedQueryOptions:n,observer:c}]:[]}),h=o.map(function(n){return n.defaultedQueryOptions.queryHash}),f=a.filter(function(n){return!h.includes(n.queryHash)}),p=s.filter(function(n){return!o.some(function(c){return c.observer===n})}),t=f.map(function(n,c){if(n.keepPreviousData){var l=p[c];if(l!==void 0)return{defaultedQueryOptions:n,observer:l}}return{defaultedQueryOptions:n,observer:e.getObserver(n)}}),d=function(c,l){return a.indexOf(c.defaultedQueryOptions)-a.indexOf(l.defaultedQueryOptions)};return o.concat(t).sort(d)},i.getObserver=function(r){var e=this.client.defaultQueryObserverOptions(r),s=this.observersMap[e.queryHash];return s??new g(this.client,e)},i.updateObservers=function(r){var e=this;y.batch(function(){var s=e.observers,a=e.findMatchingObservers(e.queries);a.forEach(function(t){return t.observer.setOptions(t.defaultedQueryOptions,r)});var o=a.map(function(t){return t.observer}),h=Object.fromEntries(o.map(function(t){return[t.options.queryHash,t]})),f=o.map(function(t){return t.getCurrentResult()}),p=o.some(function(t,d){return t!==s[d]});s.length===o.length&&!p||(e.observers=o,e.observersMap=h,e.result=f,e.hasListeners()&&(m(s,o).forEach(function(t){t.destroy()}),m(o,s).forEach(function(t){t.subscribe(function(d){e.onUpdate(t,d)})}),e.notify()))})},i.onUpdate=function(r,e){var s=this.observers.indexOf(r);s!==-1&&(this.result=R(this.result,s,e),this.notify())},i.notify=function(){var r=this;y.batch(function(){r.listeners.forEach(function(e){e(r.result)})})},v}(M);function H(b){var v=O.useRef(!1),i=O.useState(0),u=i[1],r=E(),e=Q.useMemo(function(){return b.map(function(h){var f=r.defaultQueryObserverOptions(h);return f.optimisticResults=!0,f})},[b,r]),s=O.useState(function(){return new q(r,e)}),a=s[0],o=a.getOptimisticResult(e);return O.useEffect(function(){v.current=!0;var h=a.subscribe(y.batchCalls(function(){v.current&&u(function(f){return f+1})}));return function(){v.current=!1,h()}},[a]),O.useEffect(function(){a.setQueries(e,{listeners:!1})},[e,a]),o}export{H as u};
