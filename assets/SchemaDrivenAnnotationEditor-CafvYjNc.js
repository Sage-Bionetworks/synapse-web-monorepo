import{j as e}from"./jsx-runtime-Du8NFWEI.js";import{S as ce}from"./createSvgIcon-Cg71VSX1.js";import{l as L,S as K,j as ue,g as pe,B as me}from"./useFiles-CgFN2szp.js";import"./VerificationSubmission-CWAFIXEx.js";import{x as fe}from"./StringUtils-DBSsSsIU.js";import"./OrientationBanner-BOCf4qOE.js";import{r as m}from"./index-Dl6G-zuu.js";import{d as ye,m as he}from"./useEntity-DdM_iRNY.js";import{u as G}from"./useQuery-DFbKL1Tm.js";import{P as J,A as H,d as ge,g as be,a as Se,b as U,c as ve,T as je,v as xe}from"./MuiForm-Bu5Hlrw-.js";import{i as Te}from"./isNil-CFgMzoGa.js";import{x as Fe,C as Ve}from"./ConfirmationDialog-BqIqZGDw.js";import{c as N,A as Ae,g as _e,s as we,J as Ce,a as qe,d as Pe,b as Ee}from"./JsonSchemaForm-N6QFGfWt.js";import{S as Ie}from"./LoadingScreen-DXya-_sQ.js";import{F as Ne}from"./FullWidthAlert-B_rXn9qX.js";import{G as P}from"./Grid-CED6uvP0.js";import{I as De}from"./InputLabel-DZDb4c2d.js";import"./styled-_IoEwjFQ.js";import{u as Oe}from"./use-deep-compare-effect.esm-COSQ_O61.js";import{d as ke}from"./ToastMessage-CBhzPong.js";import{T as Re}from"./Tooltip-CbFhYBpv.js";import{B as Be}from"./Button-BkKUhIiJ.js";import{T as $e}from"./TextField-B3rZxamg.js";import{T as Le}from"./TextWidget-Dck50eu7.js";import{A as I}from"./Alert-u0n1NA7e.js";import{L as Ke}from"./Link-D-YR7sBc.js";import{B as Z}from"./Box-Tu95KWeq.js";import{T as Q}from"./Typography-DUswyeAh.js";import{D as Ge}from"./Divider-DZif6ozR.js";function He(t,r){const{accessToken:n,keyFactory:a}=L();return G({...r,queryKey:a.getEntityBoundJsonSchemaQueryKey(t),queryFn:()=>K.getSchemaBinding(t,n)})}function Tt(t,r){const{accessToken:n,keyFactory:a}=L();return G({...r,queryKey:a.getEntitySchemaValidationResultsQueryKey(t),queryFn:()=>K.getSchemaValidationResults(t,n)})}function Me(t,r){const{keyFactory:n}=L();return G({...r,queryKey:n.getValidationSchemaQueryKey(t),queryFn:async()=>(await K.getValidationSchema(t)).validationSchema})}const E=t=>e.jsx(ce,{...t,width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M14 10H2V12H14V10ZM14 6H2V8H14V6ZM18 14V10H16V14H12V16H16V20H18V16H22V14H18ZM2 16H10V14H2V16Z"})});try{E.displayName="AddToList",E.__docgenInfo={description:"",displayName:"AddToList",props:{ref:{defaultValue:null,description:"",name:"ref",required:!1,type:{name:"((instance: SVGSVGElement | null) => void) | RefObject<SVGSVGElement> | null"}},component:{defaultValue:null,description:"",name:"component",required:!1,type:{name:"ElementType<any, keyof IntrinsicElements>"}}}}}catch{}const ee=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z/,We=["String","Integer","Float","Boolean","Datetime"];function D(t){return t.length===0?"String":t.every(r=>typeof r=="number"||r==="NaN")?t.every(r=>Number.isInteger(r))?"Integer":"Float":t.every(r=>typeof r=="boolean")?"Boolean":t.every(r=>typeof r=="string")&&t.every(r=>!!ee.exec(r))?"Datetime":"String"}function Y(t,r){switch(r){case"Integer":return t.map(n=>Number.isNaN(Number(n))?0:Math.floor(Number(n)));case"Float":return t.map(n=>{const a=parseFloat(n);return Number.isNaN(a)?"NaN":Number.isInteger(a)?a.toFixed(1):a});case"Datetime":return t.map(n=>typeof n=="string"&&ee.exec(n)?n:new Date().toISOString());case"Boolean":return t.map(n=>!!n);case"String":default:return t.map(n=>String(n))}}function O(t){switch(t){case"Datetime":return{type:"string",format:"datetime"};case"Boolean":return{type:"boolean"};case"Float":return{type:"number"};case"Integer":return{type:"integer"};case"String":default:return{type:"string"}}}function k(t){const{formData:r,onChange:n,registry:a,schema:b,name:c,onDropPropertyClick:u,idSchema:f}=t,s=f.$id,{ArrayField:j}=a.fields,{SelectWidget:p}=a.widgets,[l,y]=m.useState(D(N(r))),[i,x]=m.useState(l);m.useEffect(()=>{function d(){if(Array.isArray(r)){const h=r.length===0||r.every(S=>S==null||S==""),A=Y(r,i);(h||i!==l)&&ue(r,A)&&y(i)}}d()},[i]),m.useEffect(()=>{function d(){if(Array.isArray(r))if(r.every(h=>h==null))u(c)(new CustomEvent("dropEmptyProperty"));else{const h=Y(r,i);y(i),n(h)}}d()},[l]);const T=O(l);return Array.isArray(r)?e.jsxs(Ae,{value:{dropProperty:d=>{u(c)(d)}},children:[e.jsxs(P,{item:!0,xs:2,children:[e.jsx(De,{htmlFor:`${s}-type`,children:"Type"}),e.jsx(p,{name:"Type",id:`${s}-type`,schema:{},options:{enumOptions:We.map(d=>({label:d,value:d}))},value:l,onChange:d=>{x(d)},disabled:t.disabled,readOnly:t.readonly,required:!0,isClearable:!1,onBlur:()=>{},onFocus:()=>{},registry:a,label:"Type"})]}),e.jsx(P,{item:!0,xs:7,children:e.jsx(j,{...t,schema:{...b,items:{...T}}})}),l!==i&&e.jsx(Ne,{variant:"warning",title:"Data may be lost when converting types",description:`Are you sure you want to convert ${c} from ${l} to ${i}? Current values may be lost on conversion.`,primaryButtonConfig:{text:"Convert",onClick:()=>{y(i)}},secondaryButtonConfig:{text:"Cancel",onClick:()=>{x(l)}},isGlobal:!1})]}):(n(N(r)),e.jsx(e.Fragment,{}))}try{D.displayName="guessPropertyType",D.__docgenInfo={description:"",displayName:"guessPropertyType",props:{}}}catch{}try{O.displayName="getSchemaForPropertyType",O.__docgenInfo={description:"Maps a Synapse Annotation PropertyType to a JSON Schema that captures the type and format.",displayName:"getSchemaForPropertyType",props:{}}}catch{}try{k.displayName="AdditionalPropertiesSchemaField",k.__docgenInfo={description:`react-jsonschema-form SchemaField override for "additionalProperties" only. In Synapse these are "custom annotations".
Modifies the data to provide full compatibility with Synapse annotations features.

This component provides these enhancements to the SchemaField:
- Supports selecting a type, and changing the input widget appropriately
- Identifying the type on mount
- Treat all field values as arrays
- When the last array value is removed, remove the entire key from the form.`,displayName:"AdditionalPropertiesSchemaField",props:{onDropPropertyClick:{defaultValue:null,description:"",name:"onDropPropertyClick",required:!0,type:{name:"(key: string) => (event: any) => void"}}}}}catch{}function R(t){const{fields:{ObjectField:r}}=be();return m.useEffect(()=>{const{schema:n,formData:a,onChange:b}=t,c={...a};n[J]&&(Object.entries(n[J]).forEach(([u,f])=>{const s=c[u];f[H]?Array.isArray(s)||(c[u]=N(s)):typeof f=="object"&&"type"in f&&f.type!=="array"&&Array.isArray(s)&&(c[u]=s.map(j=>`${j}`).join(", "))}),ge(a,c)||b(c))}),e.jsx(r,{...t})}try{R.displayName="SynapseAnnotationsRJSFObjectField",R.__docgenInfo={description:"Extends the",displayName:"SynapseAnnotationsRJSFObjectField",props:{}}}catch{}function B(t){const{description:r,disabled:n,formData:a,idSchema:b,onAddClick:c,properties:u,readonly:f,registry:s,required:j,schema:p,title:l,uiSchema:y}=t,i=Se(y),x=U("TitleFieldTemplate",s,i),T=U("DescriptionFieldTemplate",s,i),d=m.useRef(new Set);return Oe(()=>{if("properties"in p&&p.properties){const h=Object.keys(p.properties),A=new Set(h.filter(S=>!p.properties[S][H]));if(d.current!=null){const S=Array.from(d.current).filter(g=>!A.has(g)&&!!a&&a[g]!=null&&Array.isArray(a[g])&&a[g].filter(o=>o!=null).length>0);S.length>0&&ke(`The following annotations are no longer specified by the schema and have been converted to custom fields: ${S.join(", ")}.`,"warning",{title:"Fields No Longer Specified By Schema"})}d.current=A}},[p.properties]),e.jsxs("fieldset",{id:b.$id,children:[(i.title||l)&&e.jsx(x,{id:`${b.$id}__title`,schema:p,title:i.title||l,required:j,uiSchema:y,registry:s}),(i.description||r)&&e.jsx(T,{id:`${b.$id}__description`,description:i.description||r,registry:s,schema:p}),u.map(h=>h.content),ve(p,y,a)&&e.jsx(Re,{title:"Add a new custom field",placement:"top",children:e.jsx(Be,{sx:{my:2},variant:"contained",className:"object-property-expand",onClick:c(p),disabled:n||f,"aria-label":"Add Custom Field",children:e.jsx(E,{})})})]})}try{B.displayName="ObjectFieldTemplate",B.__docgenInfo={description:`Derived from the base ObjectFieldTemplate with annotations-editor-specific changes
- Custom button for adding additional properties
- Tracks properties to show a toast message if a property is converted to an additionalProperty because it was
  dropped from the schema (e.g. in a conditional schema)

See https://github.com/rjsf-team/react-jsonschema-form/blob/main/packages/mui/src/ObjectFieldTemplate/ObjectFieldTemplate.tsx`,displayName:"ObjectFieldTemplate",props:{title:{defaultValue:null,description:"A string value containing the title for the object",name:"title",required:!0,type:{name:"string"}},description:{defaultValue:null,description:"A string value containing the description for the object",name:"description",required:!1,type:{name:"string"}},disabled:{defaultValue:null,description:"A boolean value stating if the object is disabled",name:"disabled",required:!1,type:{name:"boolean"}},properties:{defaultValue:null,description:"An array of objects representing the properties in the object",name:"properties",required:!0,type:{name:"ObjectFieldTemplatePropertyType[]"}},onAddClick:{defaultValue:null,description:"Returns a function that adds a new property to the object (to be used with additionalProperties)",name:"onAddClick",required:!0,type:{name:"(schema: S) => () => void"}},readonly:{defaultValue:null,description:"A boolean value stating if the object is read-only",name:"readonly",required:!1,type:{name:"boolean"}},required:{defaultValue:null,description:"A boolean value stating if the object is required",name:"required",required:!1,type:{name:"boolean"}},hideError:{defaultValue:null,description:"A boolean value stating if the field is hiding its errors",name:"hideError",required:!1,type:{name:"boolean"}},schema:{defaultValue:null,description:"The schema object for this object",name:"schema",required:!0,type:{name:"JSONSchema7"}},uiSchema:{defaultValue:null,description:"The uiSchema object for this object field",name:"uiSchema",required:!1,type:{name:"UiSchema<T, S, F>"}},idSchema:{defaultValue:null,description:"An object containing the id for this object & ids for its properties",name:"idSchema",required:!0,type:{name:"FieldId | (FieldId & { [x: string]: FieldId | (FieldId & { [x: string]: FieldId | (FieldId & ...) | undefined; }) | undefined; })"}},errorSchema:{defaultValue:null,description:"The optional validation errors in the form of an `ErrorSchema`",name:"errorSchema",required:!1,type:{name:"ErrorSchema<T>"}},formData:{defaultValue:null,description:"The form data for the object",name:"formData",required:!1,type:{name:"Record<string, any> | null"}},formContext:{defaultValue:null,description:"The `formContext` object that was passed to Form",name:"formContext",required:!1,type:{name:"GenericObjectType"}},registry:{defaultValue:null,description:"The `registry` object",name:"registry",required:!0,type:{name:"Registry<T, S, F>"}}}}}catch{}function $(t){const{id:r,classNames:n,disabled:a,label:b,onKeyChange:c,readonly:u,required:f,schema:s,children:j,registry:p}=t,{translateString:l}=p,y=l(je.KeyLabel,[""]);if(!(H in s))return e.jsx("div",{className:n,children:j});const x=({target:T})=>{T&&c(T.value)};return e.jsx("div",{className:n,children:e.jsxs(P,{container:!0,my:1,columnSpacing:2,rowSpacing:0,children:[e.jsx(P,{item:!0,xs:3,children:e.jsx($e,{fullWidth:!0,required:f,label:y,defaultValue:b,disabled:a||u,id:`${r}-key`,name:`${r}-key`,onBlur:u?void 0:x,type:"text"})}),j]})})}try{$.displayName="SynapseAnnotationsWrapIfAdditionalTemplate",$.__docgenInfo={description:"The `WrapIfAdditional` component is used by the `FieldTemplate` to rename, or remove properties that are\npart of an `additionalProperties` part of a schema.",displayName:"SynapseAnnotationsWrapIfAdditionalTemplate",props:{children:{defaultValue:null,description:"The field or widget component instance for this field row",name:"children",required:!0,type:{name:"ReactNode"}},label:{defaultValue:null,description:"The computed label for this field, as a string",name:"label",required:!0,type:{name:"string"}},style:{defaultValue:null,description:"An object containing the style as defined in the `uiSchema`",name:"style",required:!1,type:{name:"StyleHTMLAttributes<any>"}},disabled:{defaultValue:null,description:"A boolean value stating if the field is disabled",name:"disabled",required:!0,type:{name:"boolean"}},id:{defaultValue:null,description:"The id of the field in the hierarchy. You can use it to render a label targeting the wrapped widget",name:"id",required:!0,type:{name:"string"}},required:{defaultValue:null,description:"A boolean value stating if the field is required",name:"required",required:!1,type:{name:"boolean"}},schema:{defaultValue:null,description:"The schema object for this field",name:"schema",required:!0,type:{name:"JSONSchema7"}},uiSchema:{defaultValue:null,description:"The uiSchema object for this field",name:"uiSchema",required:!1,type:{name:"UiSchema<T, S, F>"}},readonly:{defaultValue:null,description:"A boolean value stating if the field is read-only",name:"readonly",required:!0,type:{name:"boolean"}},classNames:{defaultValue:null,description:"A string containing the base CSS classes, merged with any custom ones defined in your uiSchema",name:"classNames",required:!1,type:{name:"string"}},registry:{defaultValue:null,description:"The `registry` object",name:"registry",required:!0,type:{name:"Registry<T, S, F>"}},onDropPropertyClick:{defaultValue:null,description:"The property drop/removal event handler; Called when a field is removed in an additionalProperty context",name:"onDropPropertyClick",required:!0,type:{name:"(value: string) => () => void"}},onKeyChange:{defaultValue:null,description:"The key change event handler; Called when the key associated with a field is changed for an additionalProperty",name:"onKeyChange",required:!0,type:{name:"(value: string) => () => void"}}}}}catch{}function Je(t){return t?fe[t].reduce((r,n)=>(r[`^${n}$`]={not:{}},r),{}):{}}function z(t,r){let n=Pe(t);return r&&(n=Ee(n)),n}function X(t){const{entityId:r,schemaId:n,validationSchema:a,liveValidate:b,onSuccess:c=()=>{},onCancel:u,formRef:f,onChange:s,hideActions:j=!1}=t,p=m.useRef(null),l=f??p,[y,i]=m.useState(void 0),[x,T]=m.useState(void 0),[d,h]=m.useState(!1),[A,S]=m.useState(!1),{data:g}=ye(r,void 0,!1,{staleTime:1/0,enabled:!!r,throwOnError:!0}),o=g==null?void 0:g.entityMetadata,w=g==null?void 0:g.annotations,[C,q]=m.useState(void 0),te=m.useMemo(()=>Je(o==null?void 0:o.concreteType),[o==null?void 0:o.concreteType]),re=m.useCallback(_e(o==null?void 0:o.concreteType),[o==null?void 0:o.concreteType]);m.useEffect(()=>{w&&q(w)},[w]);const{data:F,isLoading:ne}=He(r,{enabled:!!r,refetchOnWindowFocus:!1,throwOnError:!0}),{data:ae,isLoading:ie}=Me(n??(F==null?void 0:F.jsonSchemaVersionInfo.$id)??"",{enabled:!!n||!!F,throwOnError:!0}),V=a||ae,oe=ne||ie,{mutate:se,isPending:le}=he({onSuccess:()=>{c()},onError:v=>{T(v),h(!0)}});function M(){se({...z(C,!0),...o})}const W=b??we(w,V);return e.jsx("div",{className:"JsonSchemaFormContainer",children:oe?e.jsx("div",{className:"LoadingPlaceholder",children:e.jsx(Ie,{size:30})}):e.jsxs(e.Fragment,{children:[o&&F&&e.jsxs(I,{severity:"info",sx:{mb:2},children:[e.jsx("b",{children:o.name})," requires scientific annotations specified by ",e.jsx("b",{children:F.jsonSchemaVersionInfo.$id}),". ",e.jsx("b",{children:e.jsx(Ke,{href:`${pe(me.REPO_ENDPOINT)}/repo/v1/schema/type/registered/${F.jsonSchemaVersionInfo.$id}`,target:"_blank",rel:"noopener noreferrer",children:"View required schema (JSON)"})})]}),o&&Te(C)&&F===null&&e.jsx(I,{severity:"info",children:e.jsxs(Z,{display:"flex",alignItems:"center",gap:.5,children:[e.jsxs(Q,{variant:"smallText1",children:[e.jsx("b",{children:o.name})," has no annotations. Click the"," "]}),e.jsx(E,{}),e.jsx(Q,{variant:"smallText1",children:"button to annotate."})]})}),e.jsxs(Ce,{validator:xe,liveValidate:W,noHtml5Validate:!0,formRef:l,disabled:le,formContext:{showDerivedAnnotationPlaceholder:!0,descriptionVariant:"expand",descriptionFormat:"table",allowFreeSoloEnum:!0},experimental_defaultFormStateBehavior:{emptyObjectFields:"skipDefaults"},fields:{ObjectField:R},templates:{ObjectFieldTemplate:B,WrapIfAdditionalTemplate:$},widgets:{TextWidget:Le},schema:{...V??{},patternProperties:{...(V==null?void 0:V.patternProperties)??{},...te},additionalProperties:(V==null?void 0:V.additionalProperties)??!0},uiSchema:{"ui:globalOptions":{copyable:!1,duplicateKeySuffixSeparator:"_"},additionalProperties:{"ui:field":k}},transformErrors:re,formData:C,onChange:({formData:v})=>{s&&s(v),q(v),i(void 0)},onBlur:()=>{q(z(C,!1))},onSubmit:({formData:v,errors:_},de)=>{de.preventDefault(),_&&_.length>0&&i(_),h(!1),q(v),M()},onError:v=>{i(v),(y||W)&&r&&S(!0)},children:[x&&d&&e.jsxs(I,{severity:"error",sx:{my:2},children:["Annotations could not be updated: ",x.reason]}),!j&&e.jsxs(e.Fragment,{children:[e.jsx(Ge,{sx:{my:2}}),e.jsx(Z,{display:"flex",justifyContent:"space-between",sx:{gridRowStart:5},children:e.jsx(Fe,{hasCancelButton:u!==void 0,onCancel:()=>{u&&u()},onConfirm:()=>{l.current.formElement.current.requestSubmit()},confirmButtonProps:{children:r?"Save":"Validate"}})})]})]}),A&&e.jsx(Ve,{open:!0,onConfirm:()=>{M(),S(!1)},onCancel:()=>{S(!1)},title:"Update Annotations",content:e.jsxs(e.Fragment,{children:[e.jsx("div",{children:"The following errors exist with the annotations you entered:"}),e.jsx("div",{children:e.jsx("ul",{children:(y??[]).map((v,_)=>e.jsxs("li",{children:[e.jsx("b",{children:`${qe(v)}: `})," ",`${v.message}`]},_))})}),e.jsx("div",{children:"Are you sure you want to save the invalid annotations?"})]}),confirmButtonProps:{children:"Save"}})]})})}try{X.displayName="SchemaDrivenAnnotationEditor",X.__docgenInfo={description:`Renders a form for editing an entity's annotations. The component also supports supplying just a schema ID,
but work to support annotation flows without an entity (i.e. before creating entities) is not yet complete.`,displayName:"SchemaDrivenAnnotationEditor",props:{entityId:{defaultValue:null,description:"The entity whose annotations should be edited with the form",name:"entityId",required:!1,type:{name:"string"}},schemaId:{defaultValue:null,description:"If no entity ID is supplied, the schema to use for the form",name:"schemaId",required:!1,type:{name:"string"}},validationSchema:{defaultValue:null,description:"May be used to directly provide a JSON Schema to use for the form",name:"validationSchema",required:!1,type:{name:"JSONSchema7"}},formRef:{defaultValue:null,description:"Optionally supply a ref to the form to handle submission externally with `formRef.current.submit()`.",name:"formRef",required:!1,type:{name:"RefObject<Form<any, RJSFSchema, any>>"}},liveValidate:{defaultValue:null,description:"Provide live input validation. This can cause performance degradation. By default, liveValidate will be true if an entity with a schema and existing annotations is being edited",name:"liveValidate",required:!1,type:{name:"boolean"}},onSuccess:{defaultValue:null,description:"Invoked after a successful form submission",name:"onSuccess",required:!1,type:{name:"(() => void)"}},onCancel:{defaultValue:null,description:"If defined and formRef is not supplied, shows a 'Cancel' button and runs this effect on click",name:"onCancel",required:!1,type:{name:"(() => void)"}},onChange:{defaultValue:null,description:"Passes new form data upon each change to the form",name:"onChange",required:!1,type:{name:"((annotations: Record<string, unknown>) => void)"}},hideActions:{defaultValue:null,description:"If true, the editor will not render its own submit UI.",name:"hideActions",required:!1,type:{name:"boolean"}}}}}catch{}export{E as A,X as S,Tt as a,He as u};
