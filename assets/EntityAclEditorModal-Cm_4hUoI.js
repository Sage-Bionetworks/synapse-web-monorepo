import{j as e}from"./jsx-runtime-D_zvdyIk.js";import{C as oe}from"./ConfirmCloseWithoutSavingDialog-CeRiRu5o.js";import{m as ae,v as ce,bi as le,ag as k,g as de,B as ue,ba as q}from"./useFiles-BEpxB6wu.js";import{E as pe}from"./VerificationSubmission-OWkqLMYZ.js";import{e as L,c as fe}from"./StringUtils-C5rFena9.js";import"./OrientationBanner-B37kz2yW.js";import{r as l}from"./index-BrHPMy4K.js";import{b as me,A as he,u as ge}from"./useEntityBundle-BZcbWf1Z.js";import{C as ye}from"./ConfirmationDialog-Bq1bkUGO.js";import{d as B}from"./ToastMessage-BGgcb9pE.js";import{a0 as Ie,a as Ae,P as N,n as Se}from"./SynapseConstants-BZvqbuoI.js";import{f as Ce,g as Ee,h as be,i as _e}from"./useEntity-DSAvtC1g.js";import{i as Le}from"./isEqual-f_9b43M7.js";import{c as Ne}from"./cloneDeep-B4VfFNAV.js";import{a as ve,A as Te}from"./AclEditor-8CHXEyZE.js";import{u as je}from"./useUpdateAcl-BgMuhPzg.js";import{F as we}from"./FullWidthAlert-BE613Qbw.js";import{I as xe}from"./IconSvg-iTV7KPtK.js";import{T as S}from"./Typography-C4cWgMpl.js";import{B as H}from"./Button-hgfOZiyo.js";import{u as Pe}from"./useGetEntityHeaders-C-KNMNsj.js";import{E as M}from"./EntityLink-Bo2oyqXU.js";import{L as $}from"./Link-CvxDprLk.js";import{O as De}from"./OpenData-BJ7H-wc6.js";import{u as Ue}from"./useMessage-DqlvRPEr.js";import{c as Re}from"./UserBadge-DcUI63PQ.js";import{S as Oe}from"./Stack-Cdib1l_P.js";import{A as Ge}from"./Alert-1njaMFSc.js";import{n as Ve}from"./useQuery-BP6M6Cd4.js";function F(t){const s=Ne(t);return s.sort((i,n)=>n.principalId-i.principalId),s.forEach(i=>i.accessType.sort()),s}function ke(t,s){const i=F(t),n=F(s);return Le(i,n)}function qe(t,s){return t?s?` (${t})`:t:""}function He(t,s,i){let n="",r=!1;return t&&(n+=t.trim(),r=!0),s&&(n+=" "+s.trim(),r=!0),n+=qe(i,r),n}function Me(t){return He(t.firstName,t.lastName,t.userName)}const Fe="Create local sharing settings",We="Delete local sharing settings";function T(t){const{isInherited:s,setIsInherited:i}=t;return s?e.jsxs("div",{children:[e.jsx(S,{variant:"body1",sx:{mt:2,mb:1},children:"Sharing settings are initially inherited from the parent folder or project by default. To customize settings for a specific file, folder, or table, you must create and adjust local sharing settings."}),e.jsx(H,{variant:"contained",size:"small",color:"success",startIcon:e.jsx(xe,{icon:"add",wrap:!1}),onClick:()=>i(!1),children:Fe})]}):e.jsxs("div",{children:[e.jsx(S,{variant:"body1",sx:{mt:2,mb:1},children:"The sharing settings will be inherited from the parent folder or project if local sharing settings are deleted."}),e.jsx(H,{variant:"outlined",size:"small",color:"error",onClick:()=>i(!0),children:We})]})}try{T.displayName="CreateOrDeleteLocalSharingSettingsButton",T.__docgenInfo={description:"",displayName:"CreateOrDeleteLocalSharingSettingsButton",props:{isInherited:{defaultValue:null,description:"",name:"isInherited",required:!0,type:{name:"boolean"}},setIsInherited:{defaultValue:null,description:"",name:"setIsInherited",required:!0,type:{name:"(isInherited: boolean) => void"}}}}}catch{}function j(t){const{isProject:s,isInherited:i,isAfterUpload:n=!1,benefactorId:r}=t,{data:u}=Pe(r,void 0,{enabled:!!r});return n?e.jsxs(e.Fragment,{children:[e.jsxs(S,{variant:"body1",children:["Currently, the sharing settings are inherited from the"," ",u?L(fe(u.type)).toLowerCase():"container"," ","named",r?e.jsxs(e.Fragment,{children:[" ",e.jsx(M,{entity:r})," "]}):"",". If you wish to customize settings for a particular file, folder, or table, you must establish ",e.jsx("strong",{children:"Local Sharing Settings"})," to make modifications."]}),e.jsxs(S,{variant:"body1",children:["After uploading, choose the file you want to customize sharing settings for, then navigate to File Tools >"," ",e.jsx($,{href:"https://help.synapse.org/docs/Sharing-Settings,-Permissions,-and-Conditions-for-Use.2024276030.html",children:"File Sharing Settings"}),"."]})]}):s?e.jsx(S,{variant:"body1",children:"The sharing settings shown below apply to this project and are inherited by all project contents unless local sharing settings have been set."}):i?e.jsxs(S,{variant:"body1",children:["The sharing settings shown below are currently being inherited"," ",r?e.jsxs(e.Fragment,{children:["from ",e.jsx(M,{entity:r})," "]}):"","and cannot be modified here."]}):e.jsxs(S,{variant:"body1",children:["The local sharing settings shown below are ",e.jsx("strong",{children:"not"})," being inherited from a parent resource."]})}try{j.displayName="InheritanceMessage",j.__docgenInfo={description:"",displayName:"InheritanceMessage",props:{isProject:{defaultValue:null,description:"",name:"isProject",required:!0,type:{name:"boolean"}},isInherited:{defaultValue:null,description:"",name:"isInherited",required:!0,type:{name:"boolean"}},isAfterUpload:{defaultValue:null,description:"",name:"isAfterUpload",required:!1,type:{name:"boolean"}},benefactorId:{defaultValue:null,description:"",name:"benefactorId",required:!1,type:{name:"string"}}}}}catch{}function Be(t,s,i,n){const r=s.some(o=>t===o.principalId),u=i.isIndividual,h=String(t)===n,f=Ie.includes(t);return!r&&u&&!h&&!f}function $e(t){const{subject:s,body:i,initialResourceAccessList:n,newResourceAccessList:r}=t,{data:u,isLoading:h}=ae(),{data:f,isLoading:o}=Re(r.map(m=>String(m.principalId))),y=h||o,{mutate:p,isPending:a}=Ue({onError:m=>{B(`New users couldn't be notified: ${m.reason}`)}});return{sendNotification:l.useCallback(()=>{if(y){console.error("Attempted to send notification before user profile or user group headers were loaded. This should never happen.");return}const m=r.filter(g=>{const d=f.find(c=>c.ownerId===String(g.principalId));return Be(g.principalId,n,d,u.ownerId)}).map(g=>String(g.principalId));m.length>0&&p({subject:s,body:i,recipients:m})},[i,u,n,y,r,p,s,f]),isPending:a,isLoading:y}}const ze=["CAN_VIEW","CAN_DOWNLOAD","CAN_EDIT","CAN_EDIT_DELETE","CAN_ADMINISTER"];function Ye(t){return`${t} (shared on Synapse)`}function Ke(t,s){return`${Me(t)} has shared an item with you on Synapse:
${de(ue.PORTAL_ENDPOINT)}Synapse:${s}`}function Je(t,s,i){return!t||s?!1:n=>{const r=i.ownerId===String(n.principalId),u=n.principalId===N;return!(r||u)}}function Qe(t,s,i){return!t||s?!1:n=>i.ownerId===String(n.principalId)?!1:t}function Xe(t){return s=>{if(s.principalId===N)return t?q.CAN_DOWNLOAD:q.CAN_VIEW}}const w=l.forwardRef(function(s,i){const{entityId:n,onCanSaveChange:r,onUpdateSuccess:u,isAfterUpload:h=!1}=s,{data:f}=le(),{data:o}=me(n,void 0,he,{staleTime:1/0}),y=pe.PROJECT==o.entityType,{data:p}=Ce(o.entity.parentId,{staleTime:1/0}),a=o.benefactorAcl.resourceAccess,E=l.useMemo(()=>(p==null?void 0:p.resourceAccess)??[],[p]),m=o.permissions.canChangePermissions,g=o.permissions.isEntityOpenData,d=o.benefactorAcl.id!=n,[c,x]=l.useState(d),[P,z]=l.useState(!1),[D,Y]=l.useState(),{resourceAccessList:I,setResourceAccessList:b,addResourceAccessItem:U,updateResourceAccessItem:K,removeResourceAccessItem:J,resetDirtyState:C}=je({initialResourceAccessList:a});l.useEffect(()=>{a&&(C(),b([...a]))},[a,C,b]),l.useEffect(()=>{C(),x(d)},[d,C]),l.useEffect(()=>{d==c?b(a):c&&b(E),C()},[d,a,E,C,b,c]);const Q=I.some(A=>[Ae,N,Se].includes(A.principalId)),{sendNotification:X,isLoading:Z,isPending:ee}=$e({subject:Ye(o.entity.name||""),body:Ke(f,n),initialResourceAccessList:a,newResourceAccessList:I}),v={onSuccess:()=>{P&&X(),u()},onError:A=>{Y(A)}},{mutate:R,isPending:te}=Ee(v),{mutate:O,isPending:se}=be(v),{mutate:G,isPending:ne}=_e(v),ie=te||se||ne||ee,V=l.useMemo(()=>d!=c||!ke(a,I),[a,d,c,I]),_=V||Z||ie,re=V&&h;return l.useEffect(()=>{r(_)},[r,_]),l.useImperativeHandle(i,()=>({save(){_?d!=c?c?G(n):R({id:n,resourceAccess:I}):O({...o.accessControlList,resourceAccess:I}):console.error("EntityAclEditor: save() called but canSave is false")}}),[_,R,G,o,n,d,O,c,I]),e.jsxs(Oe,{sx:{gap:2},children:[e.jsx(De,{isOpenData:g,isPublic:Q,currentUserCanUpdateSharingSettings:m}),e.jsx(j,{isProject:y,isInherited:c,benefactorId:c?p==null?void 0:p.id:n,isAfterUpload:h}),re&&e.jsx(we,{isGlobal:!1,variant:"warning",title:`Edits will affect settings of entire ${L(o==null?void 0:o.entityType).toLowerCase()}.`,description:e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["Editing the settings here will impact the sharing settings for all files and folders within this"," ",L(o==null?void 0:o.entityType).toLowerCase(),", not just the ones you've recently uploaded."]}),e.jsxs("p",{children:["View the instructions above for setting your"," ",e.jsx($,{href:"https://help.synapse.org/docs/Sharing-Settings,-Permissions,-and-Conditions-for-Use.2024276030.html",target:"_blank",children:"Local Sharing Settings"}),"."]})]})}),e.jsx(Te,{isInherited:c,canEdit:Je(m,c,f),canRemoveEntry:Qe(m,c,f),resourceAccessList:I,availablePermissionLevels:ze,emptyText:"",displayedPermissionLevelOverride:Xe(g),onAddPrincipalToAcl:A=>{A===N?U(A,k("CAN_VIEW")):U(A,k("CAN_DOWNLOAD"))},updateResourceAccessItem:K,removeResourceAccessItem:J,showNotifyCheckbox:!0,notifyCheckboxValue:P,onNotifyCheckboxChange:z,showAddRemovePublicButton:!0}),!h&&!y&&o.permissions.canEnableInheritance&&e.jsx(T,{isInherited:c,setIsInherited:x}),D&&e.jsx(Ge,{severity:"error",children:D.message})]})}),Ze=l.forwardRef(function(s,i){return e.jsx(ce,{children:e.jsx(l.Suspense,{fallback:e.jsx(ve,{}),children:e.jsx(w,{...s,ref:i})})})});try{w.displayName="EntityAclEditor",w.__docgenInfo={description:"",displayName:"EntityAclEditor",props:{entityId:{defaultValue:null,description:"The ID of the entity on which to view/edit the ACL. Note that the ACL may actually belong to an entity ancestor (benefactor).",name:"entityId",required:!0,type:{name:"string"}},onCanSaveChange:{defaultValue:null,description:"Invoked when the user can/cannot save the pending changes.",name:"onCanSaveChange",required:!0,type:{name:"(canSaveChanges: boolean) => void"}},onUpdateSuccess:{defaultValue:null,description:"Invoked when changes are successfully made.",name:"onUpdateSuccess",required:!0,type:{name:"() => void"}},isAfterUpload:{defaultValue:null,description:`Special case to show specific copy and allow changes to an inherited ACL immediately after a file is uploaded.
Note that if this is true, the entityId should be the ID of the folder or project that is the benefactor of the newly uploaded file(s)
@defaultValue false`,name:"isAfterUpload",required:!1,type:{name:"boolean"}}}}}catch{}const et=`Sharing settings determine who can access your content, and what kind of access they have. Choose people/teams and define their level of access below.

_Only Administrators can add, delete, or change access levels for other people._`,tt="https://help.synapse.org/docs/Sharing-Settings,-Permissions,-and-Conditions-for-Use.2024276030.html";function W(t){var d;const{entityId:s,open:i,onUpdateSuccess:n=Ve,onClose:r,isAfterUpload:u=!1}=t,[h,f]=l.useState(!1),[o,y]=l.useState(!1),p=l.useRef(null),{data:a}=ge(s),E=a!=null&&a.entityType?L(a==null?void 0:a.entityType):"",m=(d=a==null?void 0:a.permissions)==null?void 0:d.canChangePermissions;function g(){o?f(!0):r()}return e.jsxs(e.Fragment,{children:[e.jsx(oe,{open:h,onCancel:()=>{f(!1)},onConfirm:()=>{f(!1),r()}}),e.jsx(ye,{title:`${E} Sharing Settings`.trim(),onCancel:g,open:i,maxWidth:"md",titleHelpPopoverProps:{markdownText:et,helpUrl:tt},content:e.jsx(Ze,{ref:p,entityId:s,onCanSaveChange:c=>y(c),onUpdateSuccess:()=>{B("Permissions were successfully saved to Synapse","info"),n(),r()},isAfterUpload:u}),onConfirm:c=>{c.preventDefault(),p.current.save()},confirmButtonProps:{children:m?"Save":"OK",disabled:!o}})]})}try{W.displayName="EntityAclEditorModal",W.__docgenInfo={description:"",displayName:"EntityAclEditorModal",props:{entityId:{defaultValue:null,description:"",name:"entityId",required:!0,type:{name:"string"}},open:{defaultValue:null,description:"",name:"open",required:!0,type:{name:"boolean"}},onUpdateSuccess:{defaultValue:null,description:"",name:"onUpdateSuccess",required:!1,type:{name:"() => void"}},onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}},isAfterUpload:{defaultValue:null,description:"",name:"isAfterUpload",required:!1,type:{name:"boolean"}}}}}catch{}export{W as E};
