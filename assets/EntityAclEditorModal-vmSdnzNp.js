import{j as t}from"./jsx-runtime-N6ye8Cll.js";import{m as oe,r as ae,bp as ce,ak as k,g as le,B as de,bf as q}from"./useFiles-wPL3noqa.js";import{E as ue}from"./VerificationSubmission-dxY1kvC5.js";import{e as L,c as pe}from"./StringUtils-lE31obNl.js";import"./OrientationBanner-D3UsPxXx.js";import{r as c}from"./index-Lo42Gh79.js";import{b as fe,A as me,u as he}from"./useEntityBundle-86hf_wJQ.js";import{C as ge}from"./ConfirmationDialog-Cjk_X_mP.js";import{d as B}from"./ToastMessage-DdN-IUCN.js";import{T as ye,a as Ie,P as N,o as Ae}from"./SynapseConstants-DVzzGxGK.js";import{l as Se,m as Ee,h as Ce,n as be}from"./useEntity-CmB3zJMM.js";import{i as _e}from"./isEqual-7SDsHlZH.js";import{c as Le}from"./cloneDeep-EMhmsPM9.js";import{a as Ne,A as ve}from"./AclEditor-CyZMSv3u.js";import{u as Te}from"./useUpdateAcl-BP3OG-zO.js";import{F as je}from"./FullWidthAlert-pApCjOvL.js";import{I as Pe}from"./IconSvg-ChYYo0Fp.js";import{T as S}from"./Typography-tG7EFsUv.js";import{B as H}from"./Button-Bdir9JO_.js";import{u as we}from"./useGetEntityHeaders-CcYBM9lm.js";import{E as M}from"./EntityLink-WlUalwcc.js";import{L as $}from"./Link-029SLwqk.js";import{O as xe}from"./OpenData-d8qdu9Qc.js";import{a as Ue}from"./useMessage-CJPOnu25.js";import{c as De}from"./UserBadge-oWr8FSDJ.js";import{S as Re}from"./Stack-BeytxLtO.js";import{A as Oe}from"./Alert-DnAYteIA.js";import{n as Ge}from"./noop-DX6rZLP_.js";function F(e){const s=Le(e);return s.sort((i,n)=>n.principalId-i.principalId),s.forEach(i=>i.accessType.sort()),s}function Ve(e,s){const i=F(e),n=F(s);return _e(i,n)}function ke(e,s){return e!=null?s?` (${e})`:e:""}function qe(e,s,i){let n="",r=!1;return e&&(n+=e.trim(),r=!0),s&&(n+=" "+s.trim(),r=!0),n+=ke(i,r),n}function He(e){return qe(e.firstName,e.lastName,e.userName)}const Me="Create local sharing settings",Fe="Delete local sharing settings";function T(e){const{isInherited:s,setIsInherited:i}=e;return s?t.jsxs("div",{children:[t.jsx(S,{variant:"body1",mt:2,mb:1,children:"Sharing settings are initially inherited from the parent folder or project by default. To customize settings for a specific file, folder, or table, you must create and adjust local sharing settings."}),t.jsx(H,{variant:"contained",size:"small",color:"success",startIcon:t.jsx(Pe,{icon:"add",wrap:!1}),onClick:()=>i(!1),children:Me})]}):t.jsxs("div",{children:[t.jsx(S,{variant:"body1",mt:2,mb:1,children:"The sharing settings will be inherited from the parent folder or project if local sharing settings are deleted."}),t.jsx(H,{variant:"outlined",size:"small",color:"error",onClick:()=>i(!0),children:Fe})]})}try{T.displayName="CreateOrDeleteLocalSharingSettingsButton",T.__docgenInfo={description:"",displayName:"CreateOrDeleteLocalSharingSettingsButton",props:{isInherited:{defaultValue:null,description:"",name:"isInherited",required:!0,type:{name:"boolean"}},setIsInherited:{defaultValue:null,description:"",name:"setIsInherited",required:!0,type:{name:"(isInherited: boolean) => void"}}}}}catch{}function j(e){const{isProject:s,isInherited:i,isAfterUpload:n=!1,benefactorId:r}=e,{data:d}=we(r,void 0,{enabled:!!r});return n?t.jsxs(t.Fragment,{children:[t.jsxs(S,{variant:"body1",children:["Currently, the sharing settings are inherited from the"," ",d?L(pe(d.type)).toLowerCase():"container"," ","named",r?t.jsxs(t.Fragment,{children:[" ",t.jsx(M,{entity:r})," "]}):"",". If you wish to customize settings for a particular file, folder, or table, you must establish ",t.jsx("strong",{children:"Local Sharing Settings"})," to make modifications."]}),t.jsxs(S,{variant:"body1",children:["After uploading, choose the file you want to customize sharing settings for, then navigate to File Tools >"," ",t.jsx($,{href:"https://help.synapse.org/docs/Sharing-Settings,-Permissions,-and-Conditions-for-Use.2024276030.html",children:"File Sharing Settings"}),"."]})]}):s?t.jsx(S,{variant:"body1",children:"The sharing settings shown below apply to this project and are inherited by all project contents unless local sharing settings have been set."}):i?t.jsxs(S,{variant:"body1",children:["The sharing settings shown below are currently being inherited"," ",r?t.jsxs(t.Fragment,{children:["from ",t.jsx(M,{entity:r})," "]}):"","and cannot be modified here."]}):t.jsxs(S,{variant:"body1",children:["The local sharing settings shown below are ",t.jsx("strong",{children:"not"})," being inherited from a parent resource."]})}try{j.displayName="InheritanceMessage",j.__docgenInfo={description:"",displayName:"InheritanceMessage",props:{isProject:{defaultValue:null,description:"",name:"isProject",required:!0,type:{name:"boolean"}},isInherited:{defaultValue:null,description:"",name:"isInherited",required:!0,type:{name:"boolean"}},isAfterUpload:{defaultValue:null,description:"",name:"isAfterUpload",required:!1,type:{name:"boolean"}},benefactorId:{defaultValue:null,description:"",name:"benefactorId",required:!1,type:{name:"string"}}}}}catch{}function We(e,s,i,n){const r=s.some(o=>e===o.principalId),d=i.isIndividual,g=String(e)===n,h=ye.includes(e);return!r&&d&&!g&&!h}function Be(e){const{subject:s,body:i,initialResourceAccessList:n,newResourceAccessList:r}=e,{data:d,isLoading:g}=oe(),{data:h,isLoading:o}=De(r.map(f=>String(f.principalId))),a=g||o,{mutate:p,isPending:u}=Ue({onError:f=>{B(`New users couldn't be notified: ${f.reason}`)}});return{sendNotification:c.useCallback(()=>{if(a){console.error("Attempted to send notification before user profile or user group headers were loaded. This should never happen.");return}const f=r.filter(I=>{const m=h.find(l=>l.ownerId===String(I.principalId));return We(I.principalId,n,m,d.ownerId)}).map(I=>String(I.principalId));f.length>0&&p({subject:s,body:i,recipients:f})},[i,d,n,a,r,p,s,h]),isPending:u,isLoading:a}}const $e=["CAN_VIEW","CAN_DOWNLOAD","CAN_EDIT","CAN_EDIT_DELETE","CAN_ADMINISTER"];function ze(e){return`${e} (shared on Synapse)`}function Ye(e,s){return`${He(e)} has shared an item with you on Synapse:
${le(de.PORTAL_ENDPOINT)}Synapse:${s}`}function Ke(e,s,i){return!e||s?!1:n=>{const r=i.ownerId===String(n.principalId),d=n.principalId===N;return!(r||d)}}function Je(e,s,i){return!e||s?!1:n=>i.ownerId===String(n.principalId)?!1:e}function Qe(e){return s=>{if(s.principalId===N)return e?q.CAN_DOWNLOAD:q.CAN_VIEW}}const P=c.forwardRef(function(s,i){const{entityId:n,onCanSaveChange:r,onUpdateSuccess:d,isAfterUpload:g=!1}=s,{data:h}=ce(),{data:o}=fe(n,void 0,me,{staleTime:1/0}),a=ue.PROJECT==o.entityType,{data:p}=Se(o.entity.parentId,{staleTime:1/0}),u=o.benefactorAcl.resourceAccess,E=c.useMemo(()=>(p==null?void 0:p.resourceAccess)??[],[p]),f=o.permissions.canChangePermissions,I=o.permissions.isEntityOpenData,m=o.benefactorAcl.id!=n,[l,w]=c.useState(m),[x,z]=c.useState(!1),[U,Y]=c.useState(),{resourceAccessList:y,setResourceAccessList:b,addResourceAccessItem:D,updateResourceAccessItem:K,removeResourceAccessItem:J,resetDirtyState:C}=Te({initialResourceAccessList:u});c.useEffect(()=>{u&&(C(),b([...u]))},[u,C,b]),c.useEffect(()=>{C(),w(m)},[m,C]),c.useEffect(()=>{m==l?b(u):l&&b(E),C()},[m,u,E,C,b,l]);const Q=y.some(A=>[Ie,N,Ae].includes(A.principalId)),{sendNotification:X,isLoading:Z,isPending:ee}=Be({subject:ze(o.entity.name||""),body:Ye(h,n),initialResourceAccessList:u,newResourceAccessList:y}),v={onSuccess:()=>{x&&X(),d()},onError:A=>{Y(A)}},{mutate:R,isPending:te}=Ee(v),{mutate:O,isPending:se}=Ce(v),{mutate:G,isPending:ne}=be(v),ie=te||se||ne||ee,V=c.useMemo(()=>m!=l||!Ve(u,y),[u,m,l,y]),_=V||Z||ie,re=V&&g;return c.useEffect(()=>{r(_)},[r,_]),c.useImperativeHandle(i,()=>({save(){_?m!=l?l?G(n):R({id:n,resourceAccess:y}):O({...o.accessControlList,resourceAccess:y}):console.error("EntityAclEditor: save() called but canSave is false")}}),[_,R,G,o,n,m,O,l,y]),t.jsxs(Re,{gap:2,children:[t.jsx(xe,{isOpenData:I,isPublic:Q,currentUserCanUpdateSharingSettings:f}),t.jsx(j,{isProject:a,isInherited:l,benefactorId:l?p==null?void 0:p.id:n,isAfterUpload:g}),re&&t.jsx(je,{isGlobal:!1,variant:"warning",title:`Edits will affect settings of entire ${L(o==null?void 0:o.entityType).toLowerCase()}.`,description:t.jsxs(t.Fragment,{children:[t.jsxs("p",{children:["Editing the settings here will impact the sharing settings for all files and folders within this"," ",L(o==null?void 0:o.entityType).toLowerCase(),", not just the ones you've recently uploaded."]}),t.jsxs("p",{children:["View the instructions above for setting your"," ",t.jsx($,{href:"https://help.synapse.org/docs/Sharing-Settings,-Permissions,-and-Conditions-for-Use.2024276030.html",target:"_blank",children:"Local Sharing Settings"}),"."]})]})}),t.jsx(ve,{canEdit:Ke(f,l,h),canRemoveEntry:Je(f,l,h),resourceAccessList:y,availablePermissionLevels:$e,emptyText:"",displayedPermissionLevelOverride:Qe(I),onAddPrincipalToAcl:A=>{A===N?D(A,k("CAN_VIEW")):D(A,k("CAN_DOWNLOAD"))},updateResourceAccessItem:K,removeResourceAccessItem:J,showNotifyCheckbox:!0,notifyCheckboxValue:x,onNotifyCheckboxChange:z,showAddRemovePublicButton:!0}),!g&&!a&&o.permissions.canEnableInheritance&&t.jsx(T,{isInherited:l,setIsInherited:w}),U&&t.jsx(Oe,{severity:"error",children:U.message})]})}),Xe=c.forwardRef(function(s,i){return t.jsx(ae,{children:t.jsx(c.Suspense,{fallback:t.jsx(Ne,{}),children:t.jsx(P,{...s,ref:i})})})});try{P.displayName="EntityAclEditor",P.__docgenInfo={description:"",displayName:"EntityAclEditor",props:{entityId:{defaultValue:null,description:"The ID of the entity on which to view/edit the ACL. Note that the ACL may actually belong to an entity ancestor (benefactor).",name:"entityId",required:!0,type:{name:"string"}},onCanSaveChange:{defaultValue:null,description:"Invoked when the user can/cannot save the pending changes.",name:"onCanSaveChange",required:!0,type:{name:"(canSaveChanges: boolean) => void"}},onUpdateSuccess:{defaultValue:null,description:"Invoked when changes are successfully made.",name:"onUpdateSuccess",required:!0,type:{name:"() => void"}},isAfterUpload:{defaultValue:null,description:`Special case to show specific copy and allow changes to an inherited ACL immediately after a file is uploaded.
Note that if this is true, the entityId should be the ID of the folder or project that is the benefactor of the newly uploaded file(s)
@defaultValue false`,name:"isAfterUpload",required:!1,type:{name:"boolean"}}}}}catch{}const Ze=`Sharing settings determine who can access your content, and what kind of access they have. Choose people/teams and define their level of access below.

_Only Administrators can add, delete, or change access levels for other people._`,et="https://help.synapse.org/docs/Sharing-Settings,-Permissions,-and-Conditions-for-Use.2024276030.html";function W(e){var E;const{entityId:s,open:i,onUpdateSuccess:n=Ge,onClose:r,isAfterUpload:d=!1}=e,[g,h]=c.useState(!1),o=c.useRef(null),{data:a}=he(s),p=a!=null&&a.entityType?L(a==null?void 0:a.entityType):"",u=(E=a==null?void 0:a.permissions)==null?void 0:E.canChangePermissions;return t.jsx(ge,{title:`${p} Sharing Settings`.trim(),onCancel:r,open:i,maxWidth:"md",titleHelpPopoverProps:{markdownText:Ze,helpUrl:et},content:t.jsx(Xe,{ref:o,entityId:s,onCanSaveChange:f=>h(f),onUpdateSuccess:()=>{B("Permissions were successfully saved to Synapse","info"),n(),r()},isAfterUpload:d}),onConfirm:()=>{o.current.save()},confirmButtonProps:{children:u?"Save":"OK",disabled:!g}})}try{W.displayName="EntityAclEditorModal",W.__docgenInfo={description:"",displayName:"EntityAclEditorModal",props:{entityId:{defaultValue:null,description:"",name:"entityId",required:!0,type:{name:"string"}},open:{defaultValue:null,description:"",name:"open",required:!0,type:{name:"boolean"}},onUpdateSuccess:{defaultValue:null,description:"",name:"onUpdateSuccess",required:!1,type:{name:"() => void"}},onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}},isAfterUpload:{defaultValue:null,description:"",name:"isAfterUpload",required:!1,type:{name:"boolean"}}}}}catch{}export{W as E};
