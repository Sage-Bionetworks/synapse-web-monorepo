import{a4 as E,r as o,ca as I,cc as L}from"./iframe-05B79XZ4.js";import{u as y}from"./UserBadge-CDJVlHlx.js";import{u as T}from"./useRealmPrincipals-CjyVyGCP.js";function h(s,u,c,t){let a;(r=>{r[r.A_FIRST=-1]="A_FIRST",r[r.B_FIRST=1]="B_FIRST"})(a||(a={}));const n=s.resourceAccess.accessType.includes(E.CHANGE_PERMISSIONS),i=u.resourceAccess.accessType.includes(E.CHANGE_PERMISSIONS);return n&&!i?-1:!n&&i?1:c&&String(s.resourceAccess.principalId)===c&&String(u.resourceAccess.principalId)!==c?-1:c&&String(s.resourceAccess.principalId)!==c&&String(u.resourceAccess.principalId)===c?1:t&&String(s.resourceAccess.principalId)===t&&String(u.resourceAccess.principalId)!==t?-1:t&&String(s.resourceAccess.principalId)!==t&&String(u.resourceAccess.principalId)===t?1:s.userGroupHeader.userName.localeCompare(u.userGroupHeader.userName)}function U(s){const{data:u}=T(),{authenticatedUsersId:c,publicGroupId:t}=u,a=o.useMemo(()=>s.map(d=>d.principalId),[s]),{data:n,isLoading:i,error:r}=y(a.map(String),{enabled:a.length>0});return o.useEffect(()=>{r&&console.error("Error fetching user group headers: ",r)},[r]),{sortedResourceAccessList:o.useMemo(()=>{if(!n)return null;const d=s.map(e=>({resourceAccess:e,userGroupHeader:n.find(S=>String(S.ownerId)===String(e.principalId))}));return d.every(e=>!!e.userGroupHeader)?d.toSorted((e,S)=>h(e,S,c,t)).map(e=>e.resourceAccess):(console.warn("Some ACL entries do not have a corresponding UserGroupHeader. The ResourceAccess list will not be sorted. Missing entries: ",d.filter(e=>!e.userGroupHeader)),null)},[s,n,c,t]),isLoading:i}}const v="User or team already has permissions.",D=[];function O(s={}){const{initialResourceAccessList:u=D,onChange:c=I,onError:t=I}=s,[a,n]=o.useState(!1),{setIsEditing:i}=L();o.useEffect(()=>(i(a),()=>{i(!1)}),[a,i]);const[r,A]=o.useState(u),[d,g]=o.useState(!1),{sortedResourceAccessList:e,isLoading:S}=U(r);o.useEffect(()=>{!a&&!S&&!d&&e!=null&&(A(e),g(!0))},[d,a,S,e]),o.useEffect(()=>{c(r)},[r]);const G=o.useCallback((p,f)=>{n(!0),p&&A(l=>{if(l.some(m=>m.principalId===p))t(v);else{const m={principalId:p,accessType:f};return[...l,m]}return l})},[t]),H=o.useCallback((p,f)=>{n(!0),A(l=>l.map(R=>R.principalId===p?{...R,accessType:f}:R))},[]),C=o.useCallback(p=>{n(!0),A(f=>f.filter(l=>l.principalId!==p))},[]),_=o.useCallback(()=>{n(!1)},[]);return{resourceAccessList:r,setResourceAccessList:A,addResourceAccessItem:G,updateResourceAccessItem:H,removeResourceAccessItem:C,resetDirtyState:_}}export{O as u};
