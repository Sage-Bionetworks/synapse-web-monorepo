import{j as e}from"./jsx-runtime-Du8NFWEI.js";import{r as n}from"./index-Dl6G-zuu.js";import{l as J,i as ue,B as ce,J as pe,S as B,q as Ee,v as ye,bj as be}from"./useFiles-DgS9yAar.js";import{w as oe,D as re,E as A,c as F}from"./VerificationSubmission-DL9jxYsQ.js";import{F as me,y as xe}from"./StringUtils-By8SXO8c.js";import"./OrientationBanner-D9CLn5zV.js";import{f as Ie,g as Te,h as _e,i as ve,j as Ne,k as je}from"./useEntity--O3QjCXV.js";import{u as Oe}from"./useGetEntityChallenge-BnqhdijY.js";import{u as Me}from"./useTeam-DGKCcx_c.js";import{u as we}from"./useGetUserTeams-Ctc3voYj.js";import{u as De}from"./utils-Bx1BRerw.js";import{d as ge}from"./dayjs.min-d18Up55D.js";import{L as te}from"./chunk-K6AXKMTT-B5GX6HSq.js";import{i as Pe}from"./QueryFilterUtils-D6d8f_ZF.js";import{K as Le,N as Fe,C as Ae}from"./ConfirmationDialog-DRN0Y6d0.js";import{f as Se}from"./DateFormatter-zUiwJ_5Z.js";import{F as Re}from"./FileUpload-DWbn1dUp.js";import{I as ke}from"./IconSvg-KrLXYQAC.js";import{R as le}from"./Radio-BKgQCzNK.js";import{B as T}from"./Box-CaFleW7-.js";import{T as z}from"./Typography-DrqHmlDD.js";import{B as Be}from"./Button-DtfaTZY_.js";import{I as Ue}from"./InfoTwoTone-D-FIW5gs.js";import{D as de}from"./DataGrid-_kcVE5CG.js";import{S as Ve}from"./StepperDialog-BtxV6SY1.js";import{u as He}from"./useQuery-6SsvXKRa.js";import{T as qe}from"./TextField-CrNNFkUB.js";import{A as Ge}from"./Alert-CduaGk2B.js";import{d as ze}from"./ToastMessage-B9KBAHGM.js";function ne({pageSize:l,challengeProjectId:d,entityType:p,onItemSelected:o}){const u=De(),{accessToken:g,keyFactory:y}=J(),[r,I]=n.useState(0),[b,m]=n.useState(),[f,C]=n.useState(),[a,x]=n.useState(),[h,j]=n.useState([]),[U,M]=n.useState(),[Y,V]=n.useState(!1),[W,D]=n.useState(!1),[v,K]=n.useState(),O=l,P=50,H=`${ue(ce.PORTAL_ENDPOINT)}Synapse:${d}`,w={parentId:d,nextPageToken:Y?U:null,includeTypes:[p],includeTotalChildCount:!0,sortBy:oe.MODIFIED_ON,sortDirection:re.DESC},{data:i,refetch:E}=Le(w,{enabled:!!d,throwOnError:!0});n.useEffect(()=>{if(i){const t=[...h],s=Math.floor((r+1)*O/P)*P;t.splice(s,s+P,...i.page),j(t),V(!1),M(i.nextPageToken)}},[i]);function N(){const t=r*O;return h.slice(t,t+O)}function c(){C(void 0),x(void 0),j([]),M(void 0),V(!1),E()}n.useEffect(()=>{c()},[p,l]);const q=Ie(N()),G=n.useMemo(()=>q.filter(t=>t.status==="success").map(t=>t.data),[q]),Q=q.some(t=>t.isLoading),X=async t=>{x(!1);const S=G.find(s=>(s==null?void 0:s.id)===t);if(S){if(m(S),p===A.DOCKER_REPO){let s;try{s=await B.getDockerTag(S.id,g,0,1)}catch(L){return C(L.message)}if(s.totalNumberOfResults===0)return C("No commits have been made to this repository. Please select a repository with at least one commit.")}x(!0),C(void 0)}},Z=[{field:"radiobutton",headerName:"",width:25,sortable:!1,filterable:!1,hideable:!1,disableColumnMenu:!0,renderCell:t=>e.jsx(le,{value:t.id,checked:t.id===(b==null?void 0:b.id),onChange:S=>{X(S.target.value)}})},{field:"name",headerName:p===A.DOCKER_REPO?"Docker Repository":"File Name",flex:1,filterable:!1,hideable:!1,disableColumnMenu:!0,renderCell:t=>e.jsx(te,{to:{pathname:`${ue(ce.PORTAL_ENDPOINT)}Synapse:${t.row.id}`},target:"_blank",children:t.row.name})},{field:"modifiedOn",headerName:"Updated On",width:100,filterable:!1,hideable:!1,disableColumnMenu:!0},{field:"id",headerName:"ID",width:200,filterable:!1,hideable:!1,disableColumnMenu:!0}],_=t=>{const S=[];return t.forEach(s=>{S.push({id:s.id,name:p===A.DOCKER_REPO?s.repositoryName??s.name:s.name,modifiedOn:Se(ge(s.modifiedOn),"MM/DD/YY")})}),S},$=t=>{Math.min((i==null?void 0:i.totalChildCount)??0,(t+1)*O)>h.length&&V(!0),I(t)},R=()=>{o(b)};function ee(t){if(!t)return;const{fileHandleId:S,fileName:s}=t,L={parentId:d,name:s,concreteType:me,dataFileHandleId:S};B.createEntity(L,g).then(()=>{c()}).catch(k=>{C(k.reason)})}async function Ce(){if(!v)return;const{fileHandleId:t,entityId:S}=v;if(!S)return C("Error: missing entityId. Please try again.");let s;try{s=await B.getEntity(g,S)}catch{return C(`The entity ${S} could not be retrieved.`)}const L={id:s.id,name:s.name,dataFileHandleId:t,concreteType:me,parentId:s.parentId,etag:s.etag,modifiedOn:s.modifiedOn};try{const k=await B.updateEntity(L,g,!0);await Pe(u,y,k.id),u.setQueryData(y.getEntityQueryKey(k.id),k),c()}catch(k){C(k.reason)}}const he=async t=>{if(t.success&&t.resp){const{fileName:S}=t.resp,s={entityName:S,parentId:d};try{const L=await B.lookupChildEntity(s,g);L&&(K({...t.resp,entityId:L.id}),D(!0))}catch{K(void 0),ee(t.resp)}}else!t.success&&t.error?C(t.error.reason):C("An unknown error occurred. Please try again.")};return e.jsxs(T,{children:[e.jsxs(T,{sx:{display:"flex",backgroundColor:"#FBFBFC",padding:"10px",justifyContent:"space-between"},children:[e.jsx(z,{variant:"h6",sx:{fontSize:"18px",lineHeight:"20px",fontWeight:700},children:"Your Submission Directory"}),e.jsxs(T,{sx:{display:"flex"},children:[e.jsxs(z,{variant:"body1",sx:{fontSize:"14px",color:"#71767F"},children:["Project SynID:","  ",e.jsx(te,{to:{pathname:H},target:"_blank",children:d})]}),e.jsx(Fe,{value:H,sx:{marginTop:"-4px"}})]})]}),e.jsx(T,{children:e.jsx(de,{loading:Q,columns:Z,rows:_(G),rowCount:(i==null?void 0:i.totalChildCount)??0,pagination:!0,paginationMode:"server",paginationModel:{page:r,pageSize:O},pageSizeOptions:[O],onPaginationModelChange:({page:t})=>{$(t)},density:"compact",autoHeight:!0,sx:{fontSize:"14px",border:"none",height:"100%","& .MuiDataGrid-columnHeader":{backgroundColor:"#F1F3F5"},"& .Mui-odd":{backgroundColor:"#FBFBFC"},".MuiDataGrid-columnHeaderTitleContainer":{justifyContent:"space-between"},".radio":{display:"flex",alignItems:"center",height:"100%"}},getRowClassName:t=>t.indexRelativeToCurrentPage%2===0?"Mui-even":"Mui-odd"})}),f&&e.jsx(pe,{error:f}),e.jsxs(T,{display:"flex",justifyContent:"space-between",children:[p===A.FILE&&e.jsx(Re,{label:"Upload File",buttonProps:{variant:"outlined",endIcon:e.jsx(ke,{icon:"upload"}),sx:{lineHeight:1}},onComplete:t=>{he(t)}}),e.jsx(Be,{color:"primary",variant:"contained",onClick:R,disabled:!a,children:"Submit Selection"})]}),p===A.DOCKER_REPO&&e.jsxs(T,{mt:4,display:"flex",children:[e.jsx(Ue,{sx:{width:"16px",height:"16px",verticalAlign:"text-bottom"}}),e.jsxs(T,{ml:2,children:["To learn more about how to create and submit the Docker containers using command line, see our"," ",e.jsx(te,{to:{pathname:"https://github.com/Sage-Bionetworks-Challenges/sample-model-templates#build-your-model"},target:"_blank",children:"Docker model submission guide"}),"."]})]}),e.jsx(Ae,{open:W,title:"File exists",content:e.jsxs(z,{variant:"body1",sx:{fontSize:"16px"},children:['A file named "',v==null?void 0:v.fileName,'" (',v==null?void 0:v.entityId,") already exists in this location. Do you want to update the existing file and create a new version?"]}),onCancel:()=>D(!1),onConfirm:()=>{Ce(),D(!1)}})]})}try{ne.displayName="SubmissionDirectoryList",ne.__docgenInfo={description:"",displayName:"SubmissionDirectoryList",props:{pageSize:{defaultValue:null,description:"",name:"pageSize",required:!0,type:{name:"number"}},challengeProjectId:{defaultValue:null,description:"",name:"challengeProjectId",required:!0,type:{name:"string"}},entityType:{defaultValue:null,description:"",name:"entityType",required:!0,type:{name:"enum",value:[{value:'"file"'},{value:'"dockerrepo"'}]}},onItemSelected:{defaultValue:null,description:"",name:"onItemSelected",required:!0,type:{name:"(selected: EntityItem) => void"}}}}}catch{}function Ye(l,d=0,p=20,o=oe.CREATED_ON,u=re.DESC,g){const{accessToken:y,keyFactory:r}=J();return He({...g,queryKey:r.getPaginatedDockerTagQueryKey(l,d.toString(),p.toString(),o,u),queryFn:()=>B.getDockerTag(l,y,d,p,o,u)})}function ae({repository:l,selectedCommit:d,onCommitChanged:p}){const[o,u]=n.useState(0),g=10,{isLoading:y,data:r}=Ye(l.id,o*g,g,oe.CREATED_ON,re.DESC),I=a=>{const h=((r==null?void 0:r.results)??[]).find(j=>j.digest===a);h&&p(h)},b=[{field:"radiobutton",headerName:"",width:25,sortable:!1,filterable:!1,hideable:!1,disableColumnMenu:!0,renderCell:a=>e.jsx(le,{value:a.id,checked:a.id===(d==null?void 0:d.digest),onChange:x=>I(x.target.value)})},{field:"tag",headerName:"Tag",flex:1,filterable:!1,hideable:!1,disableColumnMenu:!0},{field:"createdOn",headerName:"Created On",width:100,filterable:!1,hideable:!1,disableColumnMenu:!0},{field:"digest",headerName:"Digest",width:200,filterable:!1,hideable:!1,disableColumnMenu:!0}],m=a=>{const x=[];return a.forEach(h=>{x.push({id:h.digest,tag:h.tag,digest:h.digest,createdOn:Se(ge(h.createdOn),"MM/DD/YY")})}),x},f=()=>m((r==null?void 0:r.results)??[]),C=a=>{u(a)};return e.jsxs(T,{children:[e.jsx(T,{sx:{display:"flex",backgroundColor:"#FBFBFC",padding:"10px",justifyContent:"space-between"},children:e.jsxs(z,{variant:"h6",sx:{fontSize:"18px",lineHeight:"20px",fontWeight:700},children:["Available commits for ",l.repositoryName]})}),e.jsx(T,{children:e.jsx(de,{loading:y,columns:b,rows:f(),rowCount:(r==null?void 0:r.totalNumberOfResults)??0,pagination:!0,paginationMode:"server",paginationModel:{page:o,pageSize:g},onPaginationModelChange:({page:a})=>C(a),pageSizeOptions:[g],density:"compact",autoHeight:!0,sx:{fontSize:"14px",border:"none",height:"100%","& .MuiDataGrid-columnHeader":{backgroundColor:"#F1F3F5"},"& .Mui-odd":{backgroundColor:"#FBFBFC"},".MuiDataGrid-columnHeaderTitleContainer":{justifyContent:"space-between"},".radio":{display:"flex",alignItems:"center",height:"100%"}},getRowClassName:a=>a.indexRelativeToCurrentPage%2===0?"Mui-even":"Mui-odd"})})]})}try{ae.displayName="SubmissionCommitList",ae.__docgenInfo={description:"",displayName:"SubmissionCommitList",props:{repository:{defaultValue:null,description:"",name:"repository",required:!0,type:{name:"EntityItem"}},selectedCommit:{defaultValue:null,description:"",name:"selectedCommit",required:!0,type:{name:"DockerCommit | undefined"}},onCommitChanged:{defaultValue:null,description:"",name:"onCommitChanged",required:!0,type:{name:"(value: DockerCommit) => void"}}}}}catch{}function ie({projectId:l,submissonName:d,selectedEvaluation:p,onSubmissionNameChange:o,onEvaluationChange:u,submissionError:g}){const{isLoading:y,data:r}=Te(l,{activeOnly:!0,accessType:F.SUBMIT}),I=[{field:"radiobutton",width:25,sortable:!1,filterable:!1,hideable:!1,disableColumnMenu:!0,renderCell:m=>e.jsx(le,{value:m.id,checked:m.id===p,onChange:f=>u(f.target.value)})},{field:"name",flex:1,filterable:!1,hideable:!1,disableColumnMenu:!0}],b=()=>{var m;return(m=r??[])==null?void 0:m.map(f=>({id:f.id,name:f.name}))};return e.jsxs(T,{children:[e.jsx(T,{sx:{display:"flex",backgroundColor:"#FBFBFC",padding:"10px"},children:e.jsx(z,{variant:"h6",sx:{fontSize:"18px",lineHeight:"20px",fontWeight:700},children:"Your Submission Directory"})}),e.jsx(de,{columns:I,rows:b(),hideFooter:!0,density:"compact",autoHeight:!0,loading:y,slots:{toolbar:()=>null},sx:{fontSize:"14px",border:"none",height:"100%","& .MuiDataGrid-columnHeaders":{display:"none"},"& .MuiDataGrid-virtualScroller":{marginTop:"0px !important"},"& .Mui-odd":{backgroundColor:"#FBFBFC"},".MuiDataGrid-columnHeaderTitleContainer":{justifyContent:"space-between"},".radio":{display:"flex",alignItems:"center",height:"100%"}},getRowClassName:m=>m.indexRelativeToCurrentPage%2===0?"Mui-even":"Mui-odd"}),e.jsxs(T,{mt:3,children:[e.jsx(z,{variant:"body1",children:"Submission Name (optional)"}),e.jsx(qe,{id:"submissionName",name:"submissionName",fullWidth:!0,onChange:m=>o(m.target.value),value:d}),g&&e.jsx(T,{mt:1,children:e.jsx(Ge,{severity:"error",children:g})})]})]})}try{ie.displayName="EvaluationQueueList",ie.__docgenInfo={description:"",displayName:"EvaluationQueueList",props:{projectId:{defaultValue:null,description:"",name:"projectId",required:!0,type:{name:"string"}},submissonName:{defaultValue:null,description:"",name:"submissonName",required:!0,type:{name:"string"}},selectedEvaluation:{defaultValue:null,description:"",name:"selectedEvaluation",required:!0,type:{name:"string | undefined"}},onSubmissionNameChange:{defaultValue:null,description:"",name:"onSubmissionNameChange",required:!0,type:{name:"(value: string) => void"}},onEvaluationChange:{defaultValue:null,description:"",name:"onEvaluationChange",required:!0,type:{name:"(value: string) => void"}},submissionError:{defaultValue:null,description:"",name:"submissionError",required:!1,type:{name:"string"}}}}}catch{}const Ke={SELECT_COMMIT:{id:"SELECT_COMMIT",title:"Select Commit for Submission",nextStep:"SELECT_EVALUATION",nextEnabled:!1},SELECT_EVALUATION:{id:"SELECT_EVALUATION",title:"Select Evaluation Queue",previousStep:"SELECT_COMMIT",confirmStep:"SUBMISSION_SUCCESS",confirmButtonText:"Submit"},SUBMISSION_SUCCESS:{id:"SUBMISSION_SUCCESS",title:"Submission Successful!",confirmButtonText:"Close",confirmEnabled:!0}},Qe={SELECT_COMMIT:{id:"SELECT_COMMIT",title:""},SELECT_EVALUATION:{id:"SELECT_EVALUATION",title:"Select Evaluation Queue",confirmStep:"SUBMISSION_SUCCESS",confirmButtonText:"Submit"},SUBMISSION_SUCCESS:{id:"SUBMISSION_SUCCESS",title:"Submission Successful!",confirmButtonText:"Close",confirmEnabled:!0}},$e=l=>l===A.DOCKER_REPO?Ke:Qe;function se({projectId:l,userId:d,teamId:p,entity:o,entityType:u,isShowingModal:g,onClose:y}){const{accessToken:r}=J(),I=$e(u),b=u===A.DOCKER_REPO?I.SELECT_COMMIT:I.SELECT_EVALUATION,[m,f]=n.useState(b),[C,a]=n.useState(),[x,h]=n.useState(),[j,U]=n.useState(""),[M,Y]=n.useState(),[V,W]=n.useState(!1),D=()=>{a(void 0),h(void 0),U(""),Y(void 0),W(!1),y(),f(b)};function v(i){!i||!I[i]||(a(void 0),f(I[i]))}async function K(){if(!M)return a("Please select an evaluation.");try{return await B.getSubmissionEligibility(M,p,r)}catch(i){return a(i.message)}}async function O(i){if(!o.id||u===A.DOCKER_REPO&&!x)return a("Error: Invalid entity or commit.");const E=i.membersEligibility.filter(c=>!c.hasConflictingSubmission&&c.isEligible&&!c.isQuotaFilled&&c.isRegistered).map(c=>({principalId:c.principalId.toString()})),N={userId:d,evaluationId:M,entityId:o.id,versionNumber:o.versionNumber??-1,teamId:p,contributors:E};u===A.DOCKER_REPO&&(N.dockerRepositoryName=o.repositoryName,N.dockerDigest=x.digest),j!==""&&(N.name=j);try{await B.submitToEvaluation(r,N,o.etag,i.eligibilityStateHash),ze("Submitted successfully!","success"),D()}catch(c){a(c.message)}}const P=async()=>{const i=await K();i&&await O(i)},H=i=>{h(i),f({...m,nextEnabled:!0})};function w(){switch(m.id){case"SELECT_COMMIT":return e.jsx(ae,{repository:o,selectedCommit:x,onCommitChanged:H});case"SELECT_EVALUATION":return e.jsx(ie,{projectId:l,submissonName:j,onSubmissionNameChange:U,selectedEvaluation:M,onEvaluationChange:i=>{f({...m,confirmEnabled:!0}),Y(i)}});case"SUBMISSION_SUCCESS":return e.jsx(z,{variant:"body1",sx:{fontSize:"16px"},children:"Your submission will be scored and results posted to the Challenge Leaderboard."});default:return e.jsx(e.Fragment,{})}}return e.jsx(Ve,{errorMessage:C,onCancel:D,onStepChange:v,open:g,onConfirm:()=>{P()},confirming:V,step:m,content:w(),loading:!1})}try{se.displayName="ChallengeSubmissionStepper",se.__docgenInfo={description:"",displayName:"ChallengeSubmissionStepper",props:{projectId:{defaultValue:null,description:"",name:"projectId",required:!0,type:{name:"string"}},userId:{defaultValue:null,description:"",name:"userId",required:!0,type:{name:"string"}},teamId:{defaultValue:null,description:"",name:"teamId",required:!0,type:{name:"string"}},entity:{defaultValue:null,description:"",name:"entity",required:!0,type:{name:"EntityItem"}},entityType:{defaultValue:null,description:"",name:"entityType",required:!0,type:{name:"enum",value:[{value:'"file"'},{value:'"dockerrepo"'}]}},isShowingModal:{defaultValue:null,description:"",name:"isShowingModal",required:!0,type:{name:"boolean"}},onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}}}}}catch{}function fe({entityType:l,projectId:d,pageSize:p=10}){const{accessToken:o}=J(),u=!!o,[g,y]=n.useState(!0),[r,I]=n.useState(),[b,m]=n.useState(),[f,C]=n.useState(),[a,x]=n.useState(),[h,j]=n.useState(),[U,M]=n.useState(),{mutate:Y}=_e(),[V,W]=n.useState(!1),[D,v]=n.useState(),[K,O]=n.useState(!1),P="",H=(_,$)=>{const R=`Challenge Submission Project-${_.projectId}-${$.id}`,ee=R.replace(/\s+/g,"_").replace(/-+/g,"_").toLowerCase();return{name:R,alias:ee,concreteType:xe,description:`This Project was automatically created for Team "${$.name}" for Challenge "${_.id}"`}},{data:w,isLoading:i}=Ee({enabled:u,throwOnError:!0}),{data:E}=Oe(d,{enabled:u&&!!d,refetchInterval:1/0,throwOnError:!0}),{data:N}=we((E==null?void 0:E.id)??P,2);n.useEffect(()=>{if(u&&E&&N){if(!(N.results.length>0))return I("Error: Please join a Submission Team before continuing."),y(!1);if(N.results.length>1)return I("Error: You are a member of more than one Submission Team. You may only belong to one Submission Team per Challenge."),y(!1);m(N.results[0])}},[E,u,N]);const{data:c}=Me(b,{enabled:!!b,refetchInterval:1/0,throwOnError:!0}),{data:q}=ve((a==null?void 0:a.alias)??P,{enabled:a!==void 0&&!!E&&!!c,throwOnError:!0});n.useEffect(()=>{q?(M(!0),C(q.id)):M(!1)},[q]);const{data:G}=Ne(f??P,{enabled:!!f&&h===!0,refetchInterval:1/0,throwOnError:!0});n.useEffect(()=>{if(G&&h===!0){const _={principalId:Number(c.id),accessType:[F.CHANGE_PERMISSIONS,F.CHANGE_SETTINGS,F.CREATE,F.DELETE,F.DOWNLOAD,F.MODERATE,F.READ,F.UPDATE]};Y({...G,resourceAccess:[...G.resourceAccess,_]}),j(!1)}},[G]);const{data:Q}=je(f,{enabled:!!f,refetchInterval:1/0,throwOnError:!0});n.useEffect(()=>{Q&&Q.canView&&Q.canAddChild&&W(!0),y(!1)},[Q]),n.useEffect(()=>{!u&&(w||!i)&&(y(!1),I("Please login to continue."))},[u,w,i]),n.useEffect(()=>{if(o&&c&&E&&!a){const _=H(E,c);x(_)}},[o,c,E,a]),n.useEffect(()=>{async function _(){const $=H(E,c),R=await be($,o);R&&R.id&&(C(R.id),j(!0))}o&&c&&E&&a&&U===!1&&_()},[o,c,E,a,U]);const X=_=>{v(_),O(!0)},Z=()=>{O(!1)};return e.jsxs(ye,{children:[g&&e.jsx("span",{"data-testid":"SpinnerButton-spinner",className:"spinner"}),V&&e.jsxs(e.Fragment,{children:[e.jsx(ne,{entityType:l,pageSize:p,challengeProjectId:f,onItemSelected:X}),w&&D&&e.jsx(se,{projectId:d,userId:w==null?void 0:w.ownerId,teamId:b,entity:D,entityType:l,isShowingModal:K,onClose:Z})]}),r&&e.jsx(pe,{error:r})]})}try{fe.displayName="ChallengeSubmission",fe.__docgenInfo={description:"",displayName:"ChallengeSubmission",props:{entityType:{defaultValue:null,description:"",name:"entityType",required:!0,type:{name:"enum",value:[{value:'"file"'},{value:'"dockerrepo"'}]}},pageSize:{defaultValue:{value:"10"},description:"",name:"pageSize",required:!1,type:{name:"number"}},projectId:{defaultValue:null,description:"",name:"projectId",required:!0,type:{name:"string"}}}}}catch{}export{fe as C};
