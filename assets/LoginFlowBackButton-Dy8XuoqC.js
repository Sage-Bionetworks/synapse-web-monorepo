import{r as D,R as w}from"./index-Dl6G-zuu.js";import{H as K,I as le,J as de,e as ce,K as z,N as pe}from"./SynapseConstants-fRcr9RXt.js";import{u as J}from"./useMutation-ItNe8E2S.js";import{n as F}from"./ApplicationSessionManager-CECkmrBg.js";import{g as re,B as oe}from"./getEndpoint-CjoHA800.js";import{j as i}from"./jsx-runtime-Du8NFWEI.js";import{F as me}from"./FullWidthAlert-DFaJ0Nkn.js";import{s as fe}from"./styled-OgyJf9MH.js";import{M as ge}from"./TextField-BYBL0P0S.js";import{B as L}from"./Box-DRdN2jdb.js";import{B as W}from"./Button-mb55Lwfk.js";import{T as H}from"./TextField-BYZwcPau.js";import{L as k}from"./Link-EkQ0dGSu.js";import{L as M}from"./LoginMethodButton-BZcWN8sv.js";import{I as Oe}from"./IconSvg-B_5LF0ig.js";import{I as Ee}from"./IconButton-CgTC7RgJ.js";function Ye(n,o){const[s,a]=D.useState("CHOOSE_AUTH_METHOD"),[p,t]=D.useState(),[l,d]=D.useState(),[O,f]=D.useState();D.useEffect(()=>{const u=new URL(window.location.href.replaceAll("#","/")),{searchParams:_}=u;if(_){const A=_.get("userId"),E=_.get("twoFaToken");A&&E&&(d(parseInt(A,10)),f(E),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(s)||a("VERIFICATION_CODE"))}},[s]),D.useEffect(()=>{o&&(f(o.twoFaToken),d(o.userId),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(s)||a("VERIFICATION_CODE"))},[o]),D.useEffect(()=>{t(void 0)},[s]);async function C(u){await F.setAccessTokenCookie(u.accessToken),localStorage.setItem(K,u.authenticationReceipt),a("LOGGED_IN"),n&&n()}const{mutate:S,isPending:x}=J({mutationFn:({username:u,password:_,authenticationReceipt:A})=>F.login(u,_,A),onError:u=>{t(u.reason)},onSuccess:async u=>{u&&("errorCode"in u?(a("VERIFICATION_CODE"),f(u.twoFaToken),d(u.userId)):await C(u))}}),{mutate:V,isPending:v}=J({mutationFn:F.loginWith2fa,onError:u=>{t(u.reason),(u.reason.includes("The provided twoFaToken is invalid")||u.reason.includes("Token has expired"))&&(console.warn(u),t("Something went wrong. Refresh the page and try again."),window.location.href.includes("twoFaToken")&&window.history.replaceState({},document.title,window.location.href.replaceAll(/(twoFaToken|userId)=[^&]*&?/g,"")))},onSuccess:C});return{step:s,onStepChange:a,submitUsernameAndPassword:(u,_)=>{t(void 0);const A=localStorage.getItem(K);S({username:u,password:_,authenticationReceipt:A})},submitOneTimePassword:(u,_=s==="RECOVERY_CODE"?"RECOVERY_CODE":"TOTP")=>{if(t(void 0),O==null||l==null){t("You did not first log in with your password or a third-party identity provider.");return}V({userId:l,twoFaToken:O,otpCode:u,otpType:_})},errorMessage:p,isLoading:x||v}}const he=fe(ge)`
  input {
    text-align: center;
  }
`,_e={TextFieldStyled:he},Ce=n=>i.jsx(_e.TextFieldStyled,{...n}),U={left:"ArrowLeft",right:"ArrowRight",backspace:"Backspace",home:"Home",end:"End"};function Re(n,o){return n<=0?[]:Array.from({length:n},o)}function ye(n,o,s){return n.map((a,p)=>o===p?s:a)}function Q(n){return n.join("")}function X(n,o){return[...n,o]}function Se(n,o,s){return n.reduce((a,p,t)=>{const{characters:l,restArrayMerged:d}=a;if(t<s)return{restArrayMerged:d,characters:X(l,p)};const[O,...f]=d;return{restArrayMerged:f,characters:X(l,O||"")}},{restArrayMerged:o,characters:[]}).characters}function Ae(n){return n.split("")}function Z(n){const o=w.useRef(()=>{throw new Error("Cannot call an event handler while rendering.")});return w.useInsertionEffect(()=>{o.current=n}),w.useCallback((...s)=>{var a;return(a=o.current)==null?void 0:a.call(o,...s)},[])}const Ie=()=>!0,Te=w.forwardRef((n,o)=>{const{value:s="",length:a=4,autoFocus:p=!1,onChange:t,TextFieldsProps:l,onComplete:d,validateChar:O=Ie,className:f,onBlur:C,...S}=n,x=w.useRef(s),V=Z(d),v=Z(e=>{const r=e.slice(0,a);return{isCompleted:r.length===a,finalValue:r}});w.useEffect(()=>{const{isCompleted:e,finalValue:r}=v(x.current);e&&V(r)},[a,V,v]);const R=Re(a,(e,r)=>({character:s[r]||"",inputRef:w.createRef()})),P=e=>R.findIndex(({inputRef:r})=>r.current===e),u=()=>R.map(({character:e})=>e),_=(e,r)=>{const c=ye(u(),e,r);return Q(c)},A=e=>{var r,c;(c=(r=R[e])==null?void 0:r.inputRef.current)==null||c.focus()},E=e=>{var r,c;(c=(r=R[e])==null?void 0:r.inputRef.current)==null||c.select()},Y=e=>{e+1!==a&&(R[e+1].character?E(e+1):A(e+1))},$=(e,r)=>typeof O!="function"?!0:O(e,r),ae=e=>{const r=P(e.target);if(r===0&&e.target.value.length>1){const{finalValue:T,isCompleted:N}=v(e.target.value);t==null||t(T),N&&(d==null||d(T)),E(T.length-1);return}const c=e.target.value[0]||"";let h=c;h&&!$(h,r)&&(h="");const m=_(r,h);t==null||t(m);const{isCompleted:I,finalValue:y}=v(m);I&&(d==null||d(y)),h!==""?m.length-1<r?E(m.length):Y(r):c===""&&m.length<=r&&E(r-1)},ie=e=>{const r=e.target,c=r.selectionStart,h=r.selectionEnd,m=P(r),I=c===0&&h===0;if(r.value===e.key)e.preventDefault(),Y(m);else if(U.backspace===e.key){if(!r.value)e.preventDefault(),E(m-1);else if(I){e.preventDefault();const y=_(m,"");t==null||t(y),y.length<=m&&E(m-1)}}else U.left===e.key?(e.preventDefault(),E(m-1)):U.right===e.key?(e.preventDefault(),E(m+1)):U.home===e.key?(e.preventDefault(),E(0)):U.end===e.key&&(e.preventDefault(),E(R.length-1))},se=e=>{const r=e.clipboardData.getData("text/plain"),c=e.target,h=R.findIndex(({character:g,inputRef:b})=>g===""||b.current===c),m=u(),I=Se(m,Ae(r),h).map((g,b)=>$(g,b)?g:""),y=Q(I);t==null||t(y);const{isCompleted:T,finalValue:N}=v(y);T?(d==null||d(N),E(a-1)):E(y.length)},ue=e=>{if(!R.some(({inputRef:r})=>r.current===e.relatedTarget)){const{isCompleted:r,finalValue:c}=v(s);C==null||C(c,r)}};return i.jsx(L,{display:"flex",gap:"20px",alignItems:"center",ref:o,className:`MuiOtpInput-Box ${f||""}`,...S,children:R.map(({character:e,inputRef:r},c)=>{const{onPaste:h,onFocus:m,onKeyDown:I,className:y,onBlur:T,...N}=typeof l=="function"?l(c)||{}:l||{};return i.jsx(Ce,{autoFocus:p?c===0:!1,autoComplete:"one-time-code",value:e,inputRef:r,className:`MuiOtpInput-TextField MuiOtpInput-TextField-${c+1} ${y||""}`,onPaste:g=>{g.preventDefault(),se(g),h==null||h(g)},onFocus:g=>{g.preventDefault(),g.target.select(),m==null||m(g)},onChange:ae,onKeyDown:g=>{ie(g),I==null||I(g)},onBlur:g=>{T==null||T(g),ue(g)},...N},c)})})}),ee=6,De=["0","1","2","3","4","5","6","7","8","9"];function j(n){const{onSubmit:o,isLoading:s}=n,[a,p]=w.useState("");return i.jsxs(L,{children:[i.jsx(Te,{autoFocus:!0,length:ee,value:a,onChange:p,onComplete:o,validateChar:t=>De.includes(t)||t==="",gap:"2px",sx:{".MuiInputBase-root":{paddingLeft:"5px",paddingRight:"5px"},".MuiFormControl-root:first-of-type > .MuiInputBase-root":{borderTopRightRadius:0,borderBottomRightRadius:0},".MuiFormControl-root:last-of-type > .MuiInputBase-root":{borderTopLeftRadius:0,borderBottomLeftRadius:0},".MuiFormControl-root:not(:first-of-type):not(:last-of-type) > .MuiInputBase-root":{borderRadius:0}}}),i.jsx(W,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:a.length!==ee||s,onClick:t=>{t.preventDefault(),o(a)},children:s?"Verifying...":"Submit"})]})}try{j.displayName="TOTPForm",j.__docgenInfo={description:"",displayName:"TOTPForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function B(n){const{resetPasswordUrl:o=`${re(oe.PORTAL_ENDPOINT)}#!PasswordReset:0`,onSubmit:s,isLoading:a}=n,[p,t]=D.useState(""),[l,d]=D.useState("");function O(f){f.preventDefault(),s(p,l)}return i.jsxs("form",{onSubmit:f=>{O(f)},children:[i.jsx(H,{required:!0,fullWidth:!0,autoFocus:!0,autoComplete:"username",label:"Username or Email Address",id:"username",type:"text",value:p,onChange:f=>t(f.target.value)}),i.jsx(H,{required:!0,fullWidth:!0,autoComplete:"current-password",label:"Password",id:"current-password",type:"password",value:l,onChange:f=>d(f.target.value)}),i.jsx(k,{href:o,children:"Forgot password?"}),i.jsx(W,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",disabled:a,sx:{height:"50px",mt:4,mb:2},children:a?"Logging you in...":"Sign in"})]})}try{B.displayName="UsernamePasswordForm",B.__docgenInfo={description:"",displayName:"UsernamePasswordForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(username: string, password: string) => void"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function G(n){const{onBeginOAuthSignIn:o,ssoRedirectUrl:s,onSelectUsernameAndPassword:a}=n;function p(t,l){o&&o(),t.preventDefault();const d=s?`${s}${l}`:`${F.getRootURL()}?provider=${l}`;F.oAuthUrlRequest(l,d).then(O=>{window.location=O.authorizationUrl}).catch(O=>{console.log("Error on oAuth url ",O)})}return i.jsxs(L,{children:[i.jsx(M,{loginMethod:le,iconName:"google24",onClick:t=>{p(t,z.GOOGLE)}}),i.jsx(M,{loginMethod:de,iconName:"orcid",onClick:t=>{p(t,z.ORCID)}}),i.jsx(M,{loginMethod:ce,iconName:"email",onClick:a})]})}try{G.displayName="AuthenticationMethodSelection",G.__docgenInfo={description:`To support Google SSO in your portal, you must add your domain to the Authorized Redirect URIs for Synapse authentication.
This can be done by visiting https://sagebionetworks.jira.com/servicedesk/customer/portal/9 to set up a collaboration.
Synapse engineers must add your redirect URL in the Google API console found at https://console.cloud.google.com/ for this functionality to work.`,displayName:"AuthenticationMethodSelection",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},onSelectUsernameAndPassword:{defaultValue:null,description:"",name:"onSelectUsernameAndPassword",required:!0,type:{name:"() => void"}}}}}catch{}const we=19;function q(n){const{onSubmit:o,isLoading:s}=n,[a,p]=w.useState("");return i.jsxs(L,{children:[i.jsx(H,{placeholder:"Enter backup code",value:a,onChange:t=>{const l=t.target.value.toLowerCase().replace(/[^a-z0-9-]/gi,"");p(l)}}),i.jsx(W,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:a.length!==we||s,onClick:t=>{t.preventDefault(),o(a)},children:s?"Verifying...":"Submit"})]})}try{q.displayName="RecoveryCodeForm",q.__docgenInfo={description:"",displayName:"RecoveryCodeForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function te(n){const{ssoRedirectUrl:o,registerAccountUrl:s=`${re(oe.PORTAL_ENDPOINT)}#!RegisterAccount:0`,resetPasswordUrl:a,onBeginOAuthSignIn:p,onStepChange:t,step:l,submitUsernameAndPassword:d,submitOneTimePassword:O,errorMessage:f,isLoading:C}=n;return i.jsxs(i.Fragment,{children:[l=="CHOOSE_AUTH_METHOD"&&i.jsx(G,{onSelectUsernameAndPassword:()=>t("USERNAME_PASSWORD"),onBeginOAuthSignIn:p,ssoRedirectUrl:o}),l==="USERNAME_PASSWORD"&&i.jsx(B,{isLoading:C,resetPasswordUrl:a,onSubmit:(S,x)=>{d(S,x)}}),l==="VERIFICATION_CODE"&&i.jsxs(i.Fragment,{children:[i.jsx(j,{isLoading:C,onSubmit:S=>{O(S,"TOTP")}}),i.jsx(k,{align:"center",color:"grey.700",sx:{display:"block",mx:"auto"},onClick:()=>t("RECOVERY_CODE"),children:"Use a backup code instead"})]}),l==="RECOVERY_CODE"&&i.jsx(q,{isLoading:C,onSubmit:S=>{O(S,"RECOVERY_CODE")}}),(l==="CHOOSE_AUTH_METHOD"||l==="USERNAME_PASSWORD")&&i.jsx(L,{sx:{display:"flex",justifyContent:"center",mt:"10px"},children:i.jsx(k,{href:s,align:"center",children:"Don't have an account? Create one now"})}),f&&i.jsx(me,{variant:"warning",isGlobal:!1,description:f})]})}try{te.displayName="LoginForm",te.__docgenInfo={description:"",displayName:"LoginForm",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},registerAccountUrl:{defaultValue:null,description:"",name:"registerAccountUrl",required:!1,type:{name:"string"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | "VERIFICATION_CODE" | "RECOVERY_CODE" | "LOGGED_IN") => void'}},twoFactorAuthenticationRequired:{defaultValue:null,description:"",name:"twoFactorAuthenticationRequired",required:!1,type:{name:"TwoFactorAuthErrorResponse"}},submitUsernameAndPassword:{defaultValue:null,description:"",name:"submitUsernameAndPassword",required:!0,type:{name:"(username: string, password: string) => void"}},submitOneTimePassword:{defaultValue:null,description:"",name:"submitOneTimePassword",required:!0,type:{name:"(code: string, otpType?: TwoFactorAuthOtpType | undefined) => void"}},errorMessage:{defaultValue:null,description:"",name:"errorMessage",required:!0,type:{name:"string | undefined"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function ve(n){switch(n){case"CHOOSE_AUTH_METHOD":return"CHOOSE_AUTH_METHOD";case"USERNAME_PASSWORD":return"CHOOSE_AUTH_METHOD";case"VERIFICATION_CODE":return"CHOOSE_AUTH_METHOD";case"RECOVERY_CODE":return"VERIFICATION_CODE";case"LOGGED_IN":return"LOGGED_IN"}}function ne(n){const{step:o,onStepChange:s,sx:a}=n;return o==="USERNAME_PASSWORD"||o==="VERIFICATION_CODE"||o==="RECOVERY_CODE"?i.jsx(Ee,{className:pe,type:"button",onClick:()=>{s(ve(o))},sx:a,children:i.jsx(Oe,{icon:"arrowBack",wrap:!1,sx:{height:"24px",width:"24px"}})}):null}try{ne.displayName="LoginFlowBackButton",ne.__docgenInfo={description:"",displayName:"LoginFlowBackButton",props:{step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | "VERIFICATION_CODE" | "RECOVERY_CODE" | "LOGGED_IN") => void'}},sx:{defaultValue:null,description:"",name:"sx",required:!1,type:{name:"SxProps"}}}}}catch{}export{ne as L,te as a,Ye as u};
