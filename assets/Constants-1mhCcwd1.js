import{r as A,R as w}from"./index-Dl6G-zuu.js";import{H as z,I as de,J as ce,e as pe,K as X,N as me}from"./SynapseConstants-DwKkHu1W.js";import{u as J}from"./useMutation-DreY5go-.js";import{n as F}from"./SynapseClient-DVOjLlPA.js";import{g as re,B as ae}from"./getEndpoint-CjoHA800.js";import{j as i}from"./jsx-runtime-Du8NFWEI.js";import"./OrientationBanner-CPsBxF8o.js";import{F as fe}from"./FullWidthAlert-DFaJ0Nkn.js";import{T as H}from"./TextField-BYZwcPau.js";import{L}from"./Link-EkQ0dGSu.js";import{B as Y}from"./Button-mb55Lwfk.js";import{L as M}from"./LoginMethodButton-Bhhweo8Y.js";import{B as P}from"./Box-DRdN2jdb.js";import{s as ge}from"./styled-OgyJf9MH.js";import{M as Oe}from"./TextField-BYBL0P0S.js";import{I as Ee}from"./IconSvg-B_5LF0ig.js";import{I as he}from"./IconButton-CgTC7RgJ.js";function Ke(n,r){const[s,a]=A.useState("CHOOSE_AUTH_METHOD"),[c,t]=A.useState(),[u,d]=A.useState(),[O,f]=A.useState();A.useEffect(()=>{const l=new URL(window.location.href.replaceAll("#","/")),{searchParams:_}=l;if(_){const R=_.get("userId"),E=_.get("twoFaToken");R&&E&&(d(parseInt(R,10)),f(E),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(s)||a("VERIFICATION_CODE"))}},[s]),A.useEffect(()=>{r&&(f(r.twoFaToken),d(r.userId),["VERIFICATION_CODE","RECOVERY_CODE","LOGGED_IN"].includes(s)||a("VERIFICATION_CODE"))},[r]),A.useEffect(()=>{t(void 0)},[s]);async function y(l){await F.setAccessTokenCookie(l.accessToken),localStorage.setItem(z,l.authenticationReceipt),a("LOGGED_IN"),n&&n()}const{mutate:v,isPending:x}=J({mutationFn:({username:l,password:_,authenticationReceipt:R})=>F.login(l,_,R),onError:l=>{t(l.reason)},onSuccess:async l=>{l&&("errorCode"in l?(a("VERIFICATION_CODE"),f(l.twoFaToken),d(l.userId)):await y(l))}}),{mutate:V,isPending:D}=J({mutationFn:F.loginWith2fa,onError:l=>{t(l.reason),(l.reason.includes("The provided twoFaToken is invalid")||l.reason.includes("Token has expired"))&&(console.warn(l),t("Something went wrong. Refresh the page and try again."),window.location.href.includes("twoFaToken")&&window.history.replaceState({},document.title,window.location.href.replaceAll(/(twoFaToken|userId)=[^&]*&?/g,"")))},onSuccess:y});return{step:s,onStepChange:a,submitUsernameAndPassword:(l,_)=>{t(void 0);const R=localStorage.getItem(z);v({username:l,password:_,authenticationReceipt:R})},submitOneTimePassword:(l,_=s==="RECOVERY_CODE"?"RECOVERY_CODE":"TOTP")=>{if(t(void 0),O==null||u==null){t("You did not first log in with your password or a third-party identity provider.");return}V({userId:u,twoFaToken:O,otpCode:l,otpType:_})},errorMessage:c,isLoading:x||D}}function j(n){const{resetPasswordUrl:r=`${re(ae.PORTAL_ENDPOINT)}#!PasswordReset:0`,onSubmit:s,isLoading:a}=n,[c,t]=A.useState(""),[u,d]=A.useState("");function O(f){f.preventDefault(),s(c,u)}return i.jsxs("form",{onSubmit:f=>{O(f)},children:[i.jsx(H,{required:!0,fullWidth:!0,autoFocus:!0,autoComplete:"username",label:"Username or Email Address",id:"username",type:"text",value:c,onChange:f=>t(f.target.value)}),i.jsx(H,{required:!0,fullWidth:!0,autoComplete:"current-password",label:"Password",id:"current-password",type:"password",value:u,onChange:f=>d(f.target.value)}),i.jsx(L,{href:r,children:"Forgot password?"}),i.jsx(Y,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",disabled:a,sx:{height:"50px",mt:4,mb:2},children:a?"Logging you in...":"Sign in"})]})}try{j.displayName="UsernamePasswordForm",j.__docgenInfo={description:"",displayName:"UsernamePasswordForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(username: string, password: string) => void"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function B(n){const{onBeginOAuthSignIn:r,ssoRedirectUrl:s,onSelectUsernameAndPassword:a}=n;function c(t,u){r&&r(),t.preventDefault();const d=s?`${s}${u}`:`${F.getRootURL()}?provider=${u}`;F.oAuthUrlRequest(u,d).then(O=>{window.location=O.authorizationUrl}).catch(O=>{console.log("Error on oAuth url ",O)})}return i.jsxs(P,{children:[i.jsx(M,{loginMethod:de,iconName:"google24",onClick:t=>{c(t,X.GOOGLE)}}),i.jsx(M,{loginMethod:ce,iconName:"orcid",onClick:t=>{c(t,X.ORCID)}}),i.jsx(M,{loginMethod:pe,iconName:"email",onClick:a})]})}try{B.displayName="AuthenticationMethodSelection",B.__docgenInfo={description:`To support Google SSO in your portal, you must add your domain to the Authorized Redirect URIs for Synapse authentication.
This can be done by visiting https://sagebionetworks.jira.com/servicedesk/customer/portal/9 to set up a collaboration.
Synapse engineers must add your redirect URL in the Google API console found at https://console.cloud.google.com/ for this functionality to work.`,displayName:"AuthenticationMethodSelection",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},onSelectUsernameAndPassword:{defaultValue:null,description:"",name:"onSelectUsernameAndPassword",required:!0,type:{name:"() => void"}}}}}catch{}const _e=ge(Oe)`
  input {
    text-align: center;
  }
`,Ce={TextFieldStyled:_e},Te=n=>i.jsx(Ce.TextFieldStyled,{...n}),N={left:"ArrowLeft",right:"ArrowRight",backspace:"Backspace",home:"Home",end:"End"};function ye(n,r){return n<=0?[]:Array.from({length:n},r)}function Re(n,r,s){return n.map((a,c)=>r===c?s:a)}function Q(n){return n.join("")}function Z(n,r){return[...n,r]}function Se(n,r,s){return n.reduce((a,c,t)=>{const{characters:u,restArrayMerged:d}=a;if(t<s)return{restArrayMerged:d,characters:Z(u,c)};const[O,...f]=d;return{restArrayMerged:f,characters:Z(u,O||"")}},{restArrayMerged:r,characters:[]}).characters}function Ie(n){return n.split("")}function ee(n){const r=w.useRef(()=>{throw new Error("Cannot call an event handler while rendering.")});return w.useInsertionEffect(()=>{r.current=n}),w.useCallback((...s)=>{var a;return(a=r.current)==null?void 0:a.call(r,...s)},[])}const Ae=()=>!0,we=w.forwardRef((n,r)=>{const{value:s="",length:a=4,autoFocus:c=!1,onChange:t,TextFieldsProps:u,onComplete:d,validateChar:O=Ae,className:f,onBlur:y,...v}=n,x=w.useRef(s),V=ee(d),D=ee(e=>{const o=e.slice(0,a);return{isCompleted:o.length===a,finalValue:o}});w.useEffect(()=>{const{isCompleted:e,finalValue:o}=D(x.current);e&&V(o)},[a,V,D]);const C=ye(a,(e,o)=>({character:s[o]||"",inputRef:w.createRef()})),b=e=>C.findIndex(({inputRef:o})=>o.current===e),l=()=>C.map(({character:e})=>e),_=(e,o)=>{const p=Re(l(),e,o);return Q(p)},R=e=>{var o,p;(p=(o=C[e])==null?void 0:o.inputRef.current)==null||p.focus()},E=e=>{var o,p;(p=(o=C[e])==null?void 0:o.inputRef.current)==null||p.select()},$=e=>{e+1!==a&&(C[e+1].character?E(e+1):R(e+1))},K=(e,o)=>typeof O!="function"?!0:O(e,o),ie=e=>{const o=b(e.target);if(o===0&&e.target.value.length>1){const{finalValue:I,isCompleted:U}=D(e.target.value);t==null||t(I),U&&(d==null||d(I)),E(I.length-1);return}const p=e.target.value[0]||"";let h=p;h&&!K(h,o)&&(h="");const m=_(o,h);t==null||t(m);const{isCompleted:S,finalValue:T}=D(m);S&&(d==null||d(T)),h!==""?m.length-1<o?E(m.length):$(o):p===""&&m.length<=o&&E(o-1)},se=e=>{const o=e.target,p=o.selectionStart,h=o.selectionEnd,m=b(o),S=p===0&&h===0;if(o.value===e.key)e.preventDefault(),$(m);else if(N.backspace===e.key){if(!o.value)e.preventDefault(),E(m-1);else if(S){e.preventDefault();const T=_(m,"");t==null||t(T),T.length<=m&&E(m-1)}}else N.left===e.key?(e.preventDefault(),E(m-1)):N.right===e.key?(e.preventDefault(),E(m+1)):N.home===e.key?(e.preventDefault(),E(0)):N.end===e.key&&(e.preventDefault(),E(C.length-1))},ue=e=>{const o=e.clipboardData.getData("text/plain"),p=e.target,h=C.findIndex(({character:g,inputRef:k})=>g===""||k.current===p),m=l(),S=Se(m,Ie(o),h).map((g,k)=>K(g,k)?g:""),T=Q(S);t==null||t(T);const{isCompleted:I,finalValue:U}=D(T);I?(d==null||d(U),E(a-1)):E(T.length)},le=e=>{if(!C.some(({inputRef:o})=>o.current===e.relatedTarget)){const{isCompleted:o,finalValue:p}=D(s);y==null||y(p,o)}};return i.jsx(P,{display:"flex",gap:"20px",alignItems:"center",ref:r,className:`MuiOtpInput-Box ${f||""}`,...v,children:C.map(({character:e,inputRef:o},p)=>{const{onPaste:h,onFocus:m,onKeyDown:S,className:T,onBlur:I,...U}=typeof u=="function"?u(p)||{}:u||{};return i.jsx(Te,{autoFocus:c?p===0:!1,autoComplete:"one-time-code",value:e,inputRef:o,className:`MuiOtpInput-TextField MuiOtpInput-TextField-${p+1} ${T||""}`,onPaste:g=>{g.preventDefault(),ue(g),h==null||h(g)},onFocus:g=>{g.preventDefault(),g.target.select(),m==null||m(g)},onChange:ie,onKeyDown:g=>{se(g),S==null||S(g)},onBlur:g=>{I==null||I(g),le(g)},...U},p)})})}),te=6,De=["0","1","2","3","4","5","6","7","8","9"];function q(n){const{onSubmit:r,isLoading:s}=n,[a,c]=w.useState("");return i.jsxs(P,{children:[i.jsx(we,{autoFocus:!0,length:te,value:a,onChange:c,onComplete:r,validateChar:t=>De.includes(t)||t==="",gap:"2px",sx:{mx:"auto",maxWidth:"350px",".MuiInputBase-root":{paddingLeft:"5px",paddingRight:"5px"},".MuiFormControl-root:first-of-type > .MuiInputBase-root":{borderTopRightRadius:0,borderBottomRightRadius:0},".MuiFormControl-root:last-of-type > .MuiInputBase-root":{borderTopLeftRadius:0,borderBottomLeftRadius:0},".MuiFormControl-root:not(:first-of-type):not(:last-of-type) > .MuiInputBase-root":{borderRadius:0}}}),i.jsx(Y,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:a.length!==te||s,onClick:t=>{t.preventDefault(),r(a)},children:s?"Verifying...":"Submit"})]})}try{q.displayName="TOTPForm",q.__docgenInfo={description:"",displayName:"TOTPForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}const ve=19;function G(n){const{onSubmit:r,isLoading:s}=n,[a,c]=w.useState("");return i.jsxs(P,{children:[i.jsx(H,{placeholder:"Enter backup code",value:a,onChange:t=>{const u=t.target.value.toLowerCase().replace(/[^a-z0-9-]/gi,"");c(u)}}),i.jsx(Y,{fullWidth:!0,type:"submit",color:"primary",variant:"contained",sx:{height:"50px",mt:4,mb:2},disabled:a.length!==ve||s,onClick:t=>{t.preventDefault(),r(a)},children:s?"Verifying...":"Submit"})]})}try{G.displayName="RecoveryCodeForm",G.__docgenInfo={description:"",displayName:"RecoveryCodeForm",props:{onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(value: string) => void"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function W(n){const{step:r,isLoading:s,onSubmit:a,onClickUseBackupCode:c,onClickUseTOTP:t}=n;return i.jsxs(i.Fragment,{children:[r==="VERIFICATION_CODE"&&i.jsxs(i.Fragment,{children:[i.jsx(q,{isLoading:s,onSubmit:u=>{a(u,"TOTP")}}),i.jsx(L,{align:"center",color:"grey.700",sx:{display:"block",mx:"auto"},onClick:()=>{c()},children:"Use a backup code instead"})]}),r==="RECOVERY_CODE"&&i.jsxs(i.Fragment,{children:[i.jsx(G,{isLoading:s,onSubmit:u=>{a(u,"RECOVERY_CODE")}}),i.jsx(L,{align:"center",color:"grey.700",sx:{display:"block",mx:"auto"},onClick:()=>{t()},children:"Use authenticator app instead"})]})]})}try{W.displayName="OneTimePasswordForm",W.__docgenInfo={description:`Component that allows the user to enter a one-time password second authentication factor,
such as a timed one-time password (TOTP) generated using a shared secret, or a single-use recovery code.`,displayName:"OneTimePasswordForm",props:{step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'}]}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}},onClickUseTOTP:{defaultValue:null,description:"",name:"onClickUseTOTP",required:!0,type:{name:"() => void"}},onClickUseBackupCode:{defaultValue:null,description:"",name:"onClickUseBackupCode",required:!0,type:{name:"() => void"}},onSubmit:{defaultValue:null,description:"",name:"onSubmit",required:!0,type:{name:"(code: string, otpType: TwoFactorAuthOtpType) => void"}}}}}catch{}function ne(n){const{ssoRedirectUrl:r,registerAccountUrl:s=`${re(ae.PORTAL_ENDPOINT)}#!RegisterAccount:0`,resetPasswordUrl:a,onBeginOAuthSignIn:c,onStepChange:t,step:u,submitUsernameAndPassword:d,submitOneTimePassword:O,errorMessage:f,isLoading:y}=n;return i.jsxs(i.Fragment,{children:[u=="CHOOSE_AUTH_METHOD"&&i.jsx(B,{onSelectUsernameAndPassword:()=>t("USERNAME_PASSWORD"),onBeginOAuthSignIn:c,ssoRedirectUrl:r}),u==="USERNAME_PASSWORD"&&i.jsx(j,{isLoading:y,resetPasswordUrl:a,onSubmit:(v,x)=>{d(v,x)}}),(u==="VERIFICATION_CODE"||u==="RECOVERY_CODE")&&i.jsx(W,{step:u,isLoading:y,onSubmit:(v,x)=>{O(v,x)},onClickUseTOTP:()=>{t("VERIFICATION_CODE")},onClickUseBackupCode:()=>{t("RECOVERY_CODE")}}),(u==="CHOOSE_AUTH_METHOD"||u==="USERNAME_PASSWORD")&&i.jsx(P,{sx:{display:"flex",justifyContent:"center",mt:"10px"},children:i.jsx(L,{href:s,align:"center",children:"Don't have an account? Create one now"})}),f&&i.jsx(fe,{variant:"warning",isGlobal:!1,description:f})]})}try{ne.displayName="LoginForm",ne.__docgenInfo={description:"",displayName:"LoginForm",props:{ssoRedirectUrl:{defaultValue:null,description:"",name:"ssoRedirectUrl",required:!1,type:{name:"string"}},registerAccountUrl:{defaultValue:null,description:"",name:"registerAccountUrl",required:!1,type:{name:"string"}},resetPasswordUrl:{defaultValue:null,description:"",name:"resetPasswordUrl",required:!1,type:{name:"string"}},onBeginOAuthSignIn:{defaultValue:null,description:"",name:"onBeginOAuthSignIn",required:!1,type:{name:"(() => void)"}},step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | ONE_TIME_PASSWORD_STEP | "LOGGED_IN") => void'}},twoFactorAuthenticationRequired:{defaultValue:null,description:"",name:"twoFactorAuthenticationRequired",required:!1,type:{name:"TwoFactorAuthErrorResponse"}},submitUsernameAndPassword:{defaultValue:null,description:"",name:"submitUsernameAndPassword",required:!0,type:{name:"(username: string, password: string) => void"}},submitOneTimePassword:{defaultValue:null,description:"",name:"submitOneTimePassword",required:!0,type:{name:"(code: string, otpType?: TwoFactorAuthOtpType | undefined) => void"}},errorMessage:{defaultValue:null,description:"",name:"errorMessage",required:!0,type:{name:"string | undefined"}},isLoading:{defaultValue:null,description:"",name:"isLoading",required:!0,type:{name:"boolean"}}}}}catch{}function xe(n){switch(n){case"CHOOSE_AUTH_METHOD":return"CHOOSE_AUTH_METHOD";case"USERNAME_PASSWORD":return"CHOOSE_AUTH_METHOD";case"VERIFICATION_CODE":return"CHOOSE_AUTH_METHOD";case"RECOVERY_CODE":return"VERIFICATION_CODE";case"LOGGED_IN":return"LOGGED_IN"}}function oe(n){const{step:r,onStepChange:s,sx:a}=n;return r==="USERNAME_PASSWORD"||r==="VERIFICATION_CODE"||r==="RECOVERY_CODE"?i.jsx(he,{className:me,type:"button",onClick:()=>{s(xe(r))},sx:a,children:i.jsx(Ee,{icon:"arrowBack",wrap:!1,sx:{height:"24px",width:"24px"}})}):null}try{oe.displayName="LoginFlowBackButton",oe.__docgenInfo={description:"",displayName:"LoginFlowBackButton",props:{step:{defaultValue:null,description:"",name:"step",required:!0,type:{name:"enum",value:[{value:'"CHOOSE_AUTH_METHOD"'},{value:'"USERNAME_PASSWORD"'},{value:'"VERIFICATION_CODE"'},{value:'"RECOVERY_CODE"'},{value:'"LOGGED_IN"'}]}},onStepChange:{defaultValue:null,description:"",name:"onStepChange",required:!0,type:{name:'(step: "CHOOSE_AUTH_METHOD" | "USERNAME_PASSWORD" | ONE_TIME_PASSWORD_STEP | "LOGGED_IN") => void'}},sx:{defaultValue:null,description:"",name:"sx",required:!1,type:{name:"SxProps"}}}}}catch{}const ze="Enter the 6-digit, time-based verification code provided by your authenticator app.",Xe="Enter a one-time backup code. Your backup code is a 16 digit code, with groups of 4 letters or numbers separated by hyphens.";export{oe as L,W as O,Xe as R,ze as T,ne as a,Ke as u};
