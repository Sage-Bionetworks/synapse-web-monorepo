var A=(t,e,s)=>{if(!e.has(t))throw TypeError("Cannot "+s)};var a=(t,e,s)=>(A(t,e,"read from private field"),s?s.call(t):e.get(t)),f=(t,e,s)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,s)},y=(t,e,s,r)=>(A(t,e,"write to private field"),r?r.call(t,s):e.set(t,s),s);var p=(t,e,s)=>(A(t,e,"access private method"),s);import{r as x}from"./index-CBqU2yxZ.js";import{ae as N,af as L,ag as T,ah as K,n as V,ai as X,aj as Y,ak as Z,al as $,am as W,an as F,ao as _,ap as ee,aq as se}from"./ApplicationSessionManager-CZGL6_Dw.js";function G(t,e){return t.filter(s=>!e.includes(s))}function te(t,e,s){const r=t.slice(0);return r[e]=s,r}var Q,R,E,d,H,w,C,P,M,z,S,I,B,U,k,j,J,re=(J=class extends N{constructor(e,s,r){super();f(this,C);f(this,M);f(this,S);f(this,B);f(this,k);f(this,Q,void 0);f(this,R,void 0);f(this,E,void 0);f(this,d,void 0);f(this,H,void 0);f(this,w,void 0);y(this,Q,e),y(this,E,[]),y(this,d,[]),p(this,C,P).call(this,[]),this.setQueries(s,r)}onSubscribe(){this.listeners.size===1&&a(this,d).forEach(e=>{e.subscribe(s=>{p(this,B,U).call(this,e,s)})})}onUnsubscribe(){this.listeners.size||this.destroy()}destroy(){this.listeners=new Set,a(this,d).forEach(e=>{e.destroy()})}setQueries(e,s,r){y(this,E,e),y(this,H,s),L.batch(()=>{const n=a(this,d),i=p(this,S,I).call(this,a(this,E));i.forEach(c=>c.observer.setOptions(c.defaultedQueryOptions,r));const u=i.map(c=>c.observer),l=u.map(c=>c.getCurrentResult()),g=u.some((c,v)=>c!==n[v]);n.length===u.length&&!g||(y(this,d,u),p(this,C,P).call(this,l),this.hasListeners()&&(G(n,u).forEach(c=>{c.destroy()}),G(u,n).forEach(c=>{c.subscribe(v=>{p(this,B,U).call(this,c,v)})}),p(this,k,j).call(this)))})}getCurrentResult(){return a(this,w)}getQueries(){return a(this,d).map(e=>e.getCurrentQuery())}getObservers(){return a(this,d)}getOptimisticResult(e,s){const r=p(this,S,I).call(this,e),n=r.map(i=>i.observer.getOptimisticResult(i.defaultedQueryOptions));return[n,i=>p(this,M,z).call(this,i??n,s),()=>r.map((i,u)=>{const l=n[u];return i.defaultedQueryOptions.notifyOnChangeProps?l:i.observer.trackResult(l)})]}},Q=new WeakMap,R=new WeakMap,E=new WeakMap,d=new WeakMap,H=new WeakMap,w=new WeakMap,C=new WeakSet,P=function(e){var s;y(this,R,e),y(this,w,p(this,M,z).call(this,e,(s=a(this,H))==null?void 0:s.combine))},M=new WeakSet,z=function(e,s){return s?T(a(this,w),s(e)):e},S=new WeakSet,I=function(e){const s=a(this,d),r=new Map(s.map(o=>[o.options.queryHash,o])),n=e.map(o=>a(this,Q).defaultQueryOptions(o)),i=n.flatMap(o=>{const O=r.get(o.queryHash);return O!=null?[{defaultedQueryOptions:o,observer:O}]:[]}),u=new Set(i.map(o=>o.defaultedQueryOptions.queryHash)),l=n.filter(o=>!u.has(o.queryHash)),g=o=>{const O=a(this,Q).defaultQueryOptions(o);return a(this,d).find(h=>h.options.queryHash===O.queryHash)??new K(a(this,Q),O)},c=l.map(o=>({defaultedQueryOptions:o,observer:g(o)})),v=(o,O)=>n.indexOf(o.defaultedQueryOptions)-n.indexOf(O.defaultedQueryOptions);return i.concat(c).sort(v)},B=new WeakSet,U=function(e,s){const r=a(this,d).indexOf(e);r!==-1&&(p(this,C,P).call(this,te(a(this,R),r,s)),p(this,k,j).call(this))},k=new WeakSet,j=function(){L.batch(()=>{this.listeners.forEach(e=>{e(a(this,R))})})},J);function oe({queries:t,...e},s){const r=V(s),n=X(),i=Y(),u=x.useMemo(()=>t.map(h=>{const m=r.defaultQueryOptions(h);return m._optimisticResults=n?"isRestoring":"optimistic",m}),[t,r,n]);u.forEach(h=>{Z(h),$(h,i)}),W(i);const[l]=x.useState(()=>new re(r,u,e)),[g,c,v]=l.getOptimisticResult(u,e.combine);x.useSyncExternalStore(x.useCallback(h=>n?()=>{}:l.subscribe(L.batchCalls(h)),[l,n]),()=>l.getCurrentResult(),()=>l.getCurrentResult()),x.useEffect(()=>{l.setQueries(u,e,{listeners:!1})},[u,e,l]);const O=g.some((h,m)=>F(u[m],h))?g.flatMap((h,m)=>{const b=u[m];if(b){const D=new K(r,b);if(F(b,h))return _(b,D,i);ee(h,n)&&_(b,D,i)}return[]}):[];if(O.length>0)throw Promise.all(O);const q=g.find((h,m)=>{const b=u[m];return b&&se({result:h,errorResetBoundary:i,throwOnError:b.throwOnError,query:r.getQueryCache().get(b.queryHash)})});if(q!=null&&q.error)throw q.error;return c(v())}export{oe as u};
